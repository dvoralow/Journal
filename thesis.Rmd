---
title: "Thesis"
output: html_document
editor_options: 
  chunk_output_type: console
---

Ctrl+Alt+i make new chunk



all the libraries required to the whole code:
```{r}

library(dplyr)
library(tidyverse)
library(devtools)
library(gridExtra)
library(ggplot2)
library(jcolors)
library(RColorBrewer)
library(lubridate)
library(mgcv)

```
end code


#----- edit daily SST from copernicus model-----
I extract daily sst from Copernicus model, between 1991-2018

```{r}
sst = read.csv("data/daily SST model 1991_2018.CSV")

#convert from K C degree
sst = sst %>% dplyr:: mutate(Ashdod_sst = Ashdod_sst-273, Jaffa_sst = Jaffa_sst-273, Michmoret_sst = Michmoret_sst-273)

sst =sst %>%  dplyr::mutate(Date = (dmy(paste0("1/1/",sst$Year))  + sst$Day - 1)) %>% dplyr::mutate(Month = lubridate::month(Date)) %>% dplyr::select(Date, Year, Month, Day, Ashdod_sst)
sst_date = sst %>% dplyr::select(Date,"SST" = Ashdod_sst) 

```



clean the data - no need to run every time

```{r eval=FALSE, include=FALSE}
 #put the net temperautre into the all_data
        #all_data=read.csv(file=paste(thesis_directory,"all_data.csv",sep = "/"),stringsAsFactors = F)
        #all_data=cbind(all_data,"Temp"=net_temp$temp)
        #write.csv(all_data,file = paste(thesis_directory,"all_data.csv",sep = "/") )=
  #names of shrimps, crabs, octopus, squids - cod names.
  drops_no_fish <- c("Lvu","Ovu","Plo","Sof","Mae","Pja","Pse")
  #names of fishes with unknown origin and general category with no speceis
  drops_no_origin=c("Ccr","MUL_UP","Sma","BOX","FIS","SPL","TRA","Eer","SAR","SPH","Sud","Sha")

  #upload the dataframes
  all_data=read.csv(file="data/final_data_1987_2018.csv", stringsAsFactors = F)
  scientific_names=read.csv(file = "data/species_scientific_name.csv" ,stringsAsFactors = F)
  species_names_seperate=read.csv(file = "data/species name_seperate.csv",stringsAsFactors = F)
  t_pref=read.csv(file = "prosseced data/mean_temp_pref_cheung.csv",stringsAsFactors = F)
  
  #----!!! net temp - need to work on!!!------#
  #net_temp=read.csv(file = "prosseced data/net_temperatures_all.csv")
  
  

 
  #sort to alepahbeta order by sp_cod - the 'all_data' and 'scientific_names' are alrady sorted
  species_names_seperate=species_names_seperate[order(species_names_seperate$Sp_code),]

  #drop the duplicates species [chaneg in their prices only]
  scientific_names=scientific_names[!duplicated(scientific_names$Sp_code),]

  
  #join season and date to all_data
  #cerate date column
  all_data$DateTime<-paste(all_data$Year,all_data$Month,all_data$Day,all_data$Start_hh,sep = "-")
  all_data$Date<-paste(all_data$Year,all_data$Month,all_data$Day,sep = "-")
    #order the column by year month day
    all_data$DateTime<-ymd_h(all_data$DateTime)
    all_data$Date = ymd(all_data$Date)
      #create week column - the number of the week in th year
      all_data$Week<-week(all_data$Date)
    
      season_data = data.frame("Season" = rep(c("winter","spring", "summer", "autumn"),each = 3),"Month" = c(12,1:11))
      
 all_data = left_join(all_data,season_data, by = "Month") 
 all_data = all_data %>% left_join(sst_date, by = "Date") %>% dplyr::select(X:Day,DateTime,Date:Season,SST,everything())

 
  #remove not fishes [alredy removed from 'speceis_names_seperate']
  all_data =all_data[ , !(names(all_data) %in% drops_no_fish)]
    write.csv(all_data,file = "prosseced data/all_data_fishes_only.csv")
  scientific_names=scientific_names[!(scientific_names$Sp_code%in%drops_no_fish),]
    write.csv(scientific_names,file ="prosseced data/sceintific_names_fishes_only.csv") 

  #remove no origin
  all_data=all_data[,!(names(all_data)%in% drops_no_origin)]
    write.csv(all_data,file = "prosseced data/all_data_fishes_known_origin.csv")
  
    scientific_names=scientific_names[!(scientific_names$Sp_code %in% drops_no_origin),]
    write.csv(scientific_names,file = "prosseced data/sceintific_names_fishes_known_origin.csv" )
  
    species_names_seperate=species_names_seperate[!(species_names_seperate$Sp_code%in%drops_no_origin),]
    write.csv(species_names_seperate,file = "prosseced data/species_names_seperate_fish_known_origin.csv" )
  
    t_pref=t_pref[!(t_pref$sp_code%in%drops_no_origin),]
    write.csv(t_pref,file = "prosseced data/mean_temp_prefference.csv")
    


``` 
end chunk


#--------------------functions--------------------------------------------------
1.annual catch
2.MTC index
3.monthly agragation the data
4.seasonal agregate the data

```{r}
#----1. annual catch----
#This function get 1 data frame and 1 vector: 
# data with "Year" and abundence of species in every net.
# vector with the sp_code names that are in the data    
#return dataframe with 1 row for any year, with annual cath [sum]
#the old code for this function is in "mtc_function", I dont think its useful
annual_catch=function(the_big_data,code){
    
    filter_data=dplyr::select(all_data,Year,code)
    filter_data=aggregate.data.frame(filter_data,list(filter_data$Year),FUN = sum,drop=F)
    filter_data=dplyr:: select(filter_data,Year=Group.1,code ) 
    return(filter_data)
  }
  

#-------2. MTC index-------

#input:
  #2 data frames: 
    #1. time index [year, month] in the first column, sum of catch for the time series, to any speicies
    #2. data with the same speceies and same order as 1, with column called "Tpref"
      #with the species prefernce temperature

#output:
  #dataframe with the time sereies and the mtc index of thes time series.
  #if one index had no caths, mtc=NA
mtc_index_calc=function(time_species_data,sp_tpref_data){
 #create a vector from the time index, and remove the time column form datafarme
  time_index=time_species_data[,1]
  time_species_data=time_species_data[,2:ncol(time_species_data)]
   #data frame with species names and Tpreference
     mtc_data=time_species_data[1,]
     mtc_data=mtc_data[0,]
     #put Tpref into mtc_data
     mtc_data[1,]=sp_tpref_data$Tpref
  
  #data frame with index name and mtc name
     mtc=data.frame("index"=NA,
                 "mtc"=NA)
    
  #loop - calculate MTC index
     for (i in 1:nrow(time_species_data)) {
      #put annual catch into mtc_data
       mtc_data[2,]=time_species_data[i,1:ncol(time_species_data)]
       #multiple annual catch*tpref of any species
       mtc_data[3,]=mtc_data[1,]*mtc_data[2,]
    
      mtc[i,2]=sum(mtc_data[3,])/sum(mtc_data[2,])
      mtc[i,1]=time_index[i]
    
     }
     
  return(mtc)
}

  
#---3. monthly agragation the data----
    #This function get 1 data frame and 1 vector: 
    # data with "Year" and abundence of species in every net.
    # vector with the sp_code names that are in the data  
    #return dataframe with 12 rows for each year, with month catch for every month [sum]
    
  month_catch=function(the_big_data,code){
   
  #take just the relevant column 
  filter_data=select(the_big_data,Year,Month,code)
    #sum the cathc by month by year
    filter_data=aggregate.data.frame(filter_data,list(filter_data$Year,filter_data$Month),FUN = sum,drop=F)
    #rename the new column and drop sum of years and month   
    filter_data=select(filter_data,Year=Group.1,Month=Group.2,code ) 
   return(filter_data)
  }
    
  
#---4. seasonal agregate the data
   season_catch=function(the_big_data,code)
   {
    #call to thte month catch function
      season_data=month_catch(the_big_data,code)
     
      #winter 12-2 monthes
      #create data frame with the winter monthes
     winter=season_data[(season_data$Month==12),]
     winter=rbind(winter,season_data[season_data$Month==1,])
     winter=rbind(winter,season_data[season_data$Month==2,])
     #sum the catch by year
     winter_data=aggregate.data.frame(winter, list( winter$Year),FUN=sum,drop = F)
     #order the data
     winter_data=select(winter_data,Year=Group.1,code)
     #create column with the name of the season
     winter_data=cbind("Season"=rep("winter"),winter_data)
     
     #repete to the all seasond
     #spring 3-5
    spring=season_data[(season_data$Month==3),]
    spring=rbind(spring,season_data[season_data$Month==4,])
    spring=rbind(spring,season_data[season_data$Month==5,])
    spring_data=aggregate.data.frame(spring, list(spring$Year),FUN=sum,drop = F)
    spring_data=select(spring_data,Year=Group.1,code)
    spring_data=cbind("Season"=rep("spring"),spring_data)
    
    #summer - 6-8
    summer=season_data[(season_data$Month==6),]
    summer=rbind(summer,season_data[season_data$Month==7,])
    summer=rbind(summer,season_data[season_data$Month==8,])
    summer_data=aggregate.data.frame(summer, list(summer$Year),FUN=sum,drop = F)
    summer_data=select(summer_data,Year=Group.1,code)
    summer_data=cbind("Season"=rep("summer"),summer_data)
    
    #autumn 9-11
    autumn=season_data[(season_data$Month==9),]
    autumn=rbind(autumn,season_data[season_data$Month==10,])
    autumn=rbind(autumn,season_data[season_data$Month==11,])
    autumn_data=aggregate.data.frame(autumn, list(autumn$Year),FUN=sum,drop = F)
    autumn_data=select(autumn_data,Year=Group.1,code)
    autumn_data=cbind("Season"=rep("autumn"),autumn_data)
    
    #one data frame with all the season catch
    season=rbind(winter_data,spring_data,summer_data,autumn_data)
    
    return(season)
   }
    

```
end chunk


#-------------------mtc calculations--------------------------------------------------------

 #----calcualte t prefference for spceis and for sp_code---

```{r}

   #the mean prefference temperature for every species - Cheung t_pref combined with myn
    t_pref=read.csv(file= "prosseced data/mean_temp_pref_cheung.csv",stringsAsFactors = F)
   
      
    
    #loop for calculating the mean temperature for every sp_code - form the mean t_pref
    #sp_code is the fisheries names, which include some species togther
    species_code<-unique(t_pref$sp_code)
    mean_tcode<-c()
    
    for (i in 1:length(species_code)
    ) {
      
      calc_data=subset(t_pref,sp_code==species_code[i])
      mean_data=mean(calc_data$Tpref)
      mean_tcode=rbind(mean_tcode,mean_data)
      
    }#end for
    row.names(mean_tcode)=unique(species_code)
    colnames(mean_tcode)=c("Tpref")
    
    #change the lokus temp to be by Epinephelus aeneus, instead of mean
    mean_tcode["EPI",]= t_pref$Tpref[t_pref$X=="Epinephelus aeneus"]
    
    #different percent for dipoldus, Mullus and Spicara
    dip=t_pref[t_pref$sp_code=="DIP",]
    sum_dip=sum(dip$Tpref_percent)
    mean_tcode["DIP",]=sum_dip
    
    mull=t_pref[t_pref$sp_code=="MUL",]
    sum_mull=sum(mull$Tpref_percent)
    mean_tcode["MUL",]=sum_mull
    
    spi=t_pref[t_pref$sp_code=="SPI",]
    sum_spi=sum(spi$Tpref_percent)
    mean_tcode["SPI",]=sum_spi
    
    #calculate the temperature of WHT code, and join it to mean_tcode data
    wht_temp=0.8*mean_tcode["DIP",]+0.2*mean_tcode["Lmo",]
    wht_temp=as.data.frame(wht_temp)
    row.names(wht_temp)="WHT"
    colnames(wht_temp)="Tpref"
    mean_tcode=rbind(mean_tcode,wht_temp)
    
    #----!!!!!! need to do for siganus!! ---
    
```



#----mean month, season and year net temperature and depth----
```{r}

   #----mean month, season and year net temperature and depth----
    all_data=read.csv(file= "prosseced data/all_data_fishes_known_origin.csv", stringsAsFactors = F)
    #-- mean year temp
    #select yaer and temperature column
    year_temp= dplyr:: select(all_data,Year,SST)
    #remove 0 and NA rows
    year_temp=year_temp[year_temp$SST!=0,]
    year_temp=na.omit(year_temp)
    #mean of the temperature
    year_temp=aggregate.data.frame(year_temp,list(year_temp$Year),FUN = mean,drop=F)
    year_temp=select(year_temp,Year,SST )
    # 
    #mean year depth
    year_depth= dplyr:: select(all_data,Year,loc_DEPTH)
    year_depth=year_depth[year_depth$loc_DEPTH!=0,] 
    year_depth=na.omit(year_depth) 
    year_depth=aggregate.data.frame(year_depth,list(year_depth$Year),FUN = mean,drop = F)
    year_depth=dplyr:: select(year_depth,Year,loc_DEPTH)
    #start year depth in 1991
    year_depth=year_depth[year_depth$Year %in% 1991:2018,]
    #bind the temperature and depth
   year_temp_depth=cbind(year_temp,"Depth"=year_depth$loc_DEPTH)
  
     plot(year_depth)
    plot(year_temp)
    
    
    
#--mean month depth and temperature
    month_depth=dplyr:: select(all_data,Year,Month,loc_DEPTH)
    #remove 0 and NA
    month_depth=na.omit(month_depth)
    month_depth=month_depth[month_depth$loc_DEPTH!=0,]
    #aggregate by year by month
    month_depth=aggregate.data.frame(month_depth,list(month_depth$Year,month_depth$Month),FUN = mean,drop = F)
    month_depth=na.omit(month_depth)
    month_depth=dplyr:: select(month_depth,Year=Group.1,Month=Group.2,Depth=loc_DEPTH)
    month_depth=month_depth[month_depth$Year %in% c(1991:2018),]
    
    #mean month net temperature - same as month depth [seperate because the NA rows doesn't equal]
    month_temp=dplyr:: select(all_data,Year,Month,SST)
    month_temp=na.omit(month_temp)
    month_temp=month_temp[month_temp$SST!=0,]
    month_temp=aggregate.data.frame(month_temp,list(month_temp$Year,month_temp$Month),FUN=mean,drop = F)
    month_temp=na.omit(month_temp)
    month_temp=dplyr:: select(month_temp,Year=Group.1,Month=Group.2,SST)

    month_temp_depth=cbind(month_temp,Depth=month_depth$Depth)
     
    
#---mean season depth and temperature
    #vectors with the seasons monthes numbers
    winter_vec=c(12,1,2)
    spring_vec=c(3:5)
    summer_vec=c(6:8)  
    autumn_vec=c(9:11)
    
    #mean with net temperature
    
    #make mean for any season
    #choose the winter data
    winter_temp=month_temp_depth[month_temp_depth$Month %in% winter_vec,]
    #mean temperature and depth by year
    winter_temp=aggregate.data.frame(winter_temp,list(winter_temp$Year),FUN = mean,drop = F)
    #remove the calcukations columns
    winter_temp=dplyr:: select(winter_temp,Year,SST,Depth)
    #join column with the season name
    winter_temp=cbind("Season"=rep("winter"),winter_temp)

    spring_temp=month_temp_depth[month_temp_depth$Month %in% spring_vec,]
    spring_temp=aggregate.data.frame(spring_temp,list(spring_temp$Year),FUN=mean,drop = F)
    spring_temp=dplyr:: select(spring_temp,Year,SST,Depth)
    spring_temp=cbind("Season"=rep("spring"),spring_temp)

    summer_temp=month_temp_depth[month_temp_depth$Month %in% summer_vec,]
    summer_temp=aggregate.data.frame(summer_temp,list(summer_temp$Year), FUN = mean,drop = F)
    summer_temp=dplyr:: select(summer_temp,Year,SST,Depth)
    summer_temp=cbind("Season"=rep("summer"),summer_temp)

    autumn_temp=month_temp_depth[month_temp_depth$Month %in% autumn_vec,]
    autumn_temp=aggregate.data.frame(autumn_temp,list(autumn_temp$Year),FUN=mean,drop = F)
    autumn_temp=dplyr:: select(autumn_temp,Year,SST,Depth)
    autumn_temp=cbind("Season"=rep("autumn"),autumn_temp)
    #join all seasons to 1 data frame
    season_temp_depth=rbind(winter_temp,spring_temp,summer_temp,autumn_temp)
    

```


#--- calling annual catch function---
```{r}
 species_to_scientific_name=read.csv(file= "prosseced data/sceintific_names_fishes_known_origin.csv" ,stringsAsFactors = F)
  all_data=read.csv(file= "prosseced data/all_data_fishes_known_origin.csv",stringsAsFactors = F)
  species_code<-unique(species_to_scientific_name$Sp_code)  
  annual_sp_catch=annual_catch(all_data,species_code)
    
  write.csv(annual_sp_catch,file = "prosseced data/annual_catch.csv")
    
  

```
 

    
#---calling mtc function---
```{r}
annual_mtc=mtc_index_calc(annual_sp_catch,mean_tcode)
#start from 1991
annual_mtc=annual_mtc[annual_mtc$index %in% c(1991:2018),]
year_depth = year_depth[year_depth$Year %in% c(1991:2018),]

#bind mean net temperature and mean depth
annual_mtc=cbind("mtc"=annual_mtc$mtc,year_temp_depth)


plot(annual_mtc,main="annual mtc")

ggplot(annual_mtc, aes(x=loc_DEPTH,y=mtc,colour=Year, size=5))+
  geom_point()+scale_color_brewer(palette="
                                  Reds")+
  ggtitle("Annual Catch MTC by mean net temperature")



ggplot(annual_mtc, aes(x=Year,y=mtc,colour=loc_DEPTH, size=3))+
  geom_point()+
  ggtitle("Annual catch MTC by year")

scale_color_brewer(palette="Dark2")

```

#--seperate mediterrinian and red sea species
```{r}
species_to_scientific_name=read.csv(file= "prosseced data/sceintific_names_fishes_known_origin.csv",stringsAsFactors = F)
all_data=read.csv(file="prosseced data/all_data_fishes_known_origin.csv" ,stringsAsFactors = F)

#sp_code of the mediterrinian and red sea origin 
mediter_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Med"),"Sp_code"]
red_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Red"),"Sp_code"]

#split all_data to the mediterriania and the red sea origin
mediter_all_data=all_data[,which(!(colnames(all_data) %in% red_code))]
red_all_data=all_data[,which(!(colnames(all_data) %in% mediter_code))]

#create Tpref seperate for mediterrianian and red sea origin
mediter_mean_tcode=as.data.frame( mean_tcode[which(!(rownames(mean_tcode) %in% red_code)),])
rownames(mediter_mean_tcode)=mediter_code
colnames(mediter_mean_tcode)="Tpref"
red_mean_tcode=as.data.frame(mean_tcode[which(!(rownames(mean_tcode) %in% mediter_code)),])
rownames(red_mean_tcode)=red_code
colnames(red_mean_tcode)="Tpref"

#call to annual catch function
mediter_annual_catch=annual_catch(mediter_all_data,mediter_code)
red_annual_catch=annual_catch(red_all_data,red_code)

#call to mtc function 
mediter_annual_mtc=mtc_index_calc(mediter_annual_catch,mediter_mean_tcode)
red_annual_mtc=mtc_index_calc(red_annual_catch,red_mean_tcode)

#start in 1991 and bind mean net temperature and mean depth
mediter_annual_mtc=mediter_annual_mtc[mediter_annual_mtc$index %in% c(1991:2018),]
red_annual_mtc=red_annual_mtc[red_annual_mtc$index %in% c(1991:2018),]
mediter_annual_mtc=cbind("mtc"=mediter_annual_mtc$mtc,year_temp_depth)
red_annual_mtc=cbind("mtc"=red_annual_mtc$mtc,year_temp_depth)

mediter_annual_mtc=cbind("mtc"=mediter_annual_mtc$mtc,year_depth)
red_annual_mtc=cbind("mtc"=red_annual_mtc$mtc,year_depth)



plot(mediter_annual_mtc, main="Mediterrinian Annual mtc")
plot(red_annual_mtc,main="Red Annual mtc")

 ggplot(mediter_annual_mtc, aes(x=SST,y=mtc,colour=Year, size=3))+
   geom_point()+
   ggtitle("Annual Mediterranian species MTC by mean net temperature")

 ggplot(mediter_annual_mtc, aes(x=SST,y=mtc,colour=Depth))+
   geom_point()+
   ggtitle("Annual Mediterranian species MTC by mean net temperature")

 ggplot(mediter_annual_mtc, aes(x=Year,y=mtc,colour=SST, size=3))+
   geom_point()+
   ggtitle("Annual Mediterranian species MTC by year")

 ggplot(red_annual_mtc, aes(x=SST,y=mtc,colour=Year, size=3))+
   geom_point()+
   ggtitle("Annual Red sea species MTC by mean net temperature")

 ggplot(red_annual_mtc, aes(x=SST,y=mtc,colour=Depth))+
   geom_point()+
   ggtitle("Annual Red sea species MTC by mean net temperature")

 ggplot(red_annual_mtc, aes(x=Year,y=mtc,colour=SST, size=3))+
   geom_point()+
   ggtitle("Annual Red Sea species MTC by year")

ggplot(red_annual_mtc, aes(x=Year,y=mtc,colour=loc_DEPTH, size=3))+
  geom_point()+
  ggtitle("Annual Red Sea species MTC by year")

ggplot(mediter_annual_mtc, aes(x=Year,y=mtc,colour=loc_DEPTH, size=3))+
  geom_point()+
  ggtitle("Annual Mediterranian species MTC by year")

```


#----month mtc----
```{r}
      #---all_fishes
  #call the month catch function
  monthly_all_catch=month_catch(all_data,species_code)
 

month_all_mtc=data.frame()
#loop for the mtc in every month
  for (i in 1:12) {
  
    month_1=monthly_all_catch[which(monthly_all_catch$Month ==i),]
    month_1=dplyr:: select(month_1,-(Month))
    month_mtc=mtc_index_calc(month_1,mean_tcode)
   # plot(month_mtc,main=paste("Month", i ,"MTC"))
      
    
    #ggplot(month_mtc,aes(x=index,y=mtc))+geom_point()+ggtitle(paste("Month",i,"MTC"))
    
    month_all_mtc=rbind(month_all_mtc,month_mtc)
  }
month_all_mtc=cbind(month_all_mtc,"Month"= c(rep(1:12,each=((nrow(month_all_mtc))/12))))

    #----seperate by origin---
    #call the month catch function
  month_mediter_catch=month_catch(mediter_all_data,mediter_code )
month_red_catch=month_catch(red_all_data, red_code)   

month_mediter_mtc=data.frame()
month_red_mtc=data.frame()
#loop for the mtc in every month to every origin
for (i in 1:12) {
  mediter_month=month_mediter_catch[which(month_mediter_catch$Month==i),]
  red_month=month_red_catch[which(month_red_catch$Month==i),]
  
  mediter_month=dplyr:: select(mediter_month,-(Month))
  red_month=dplyr:: select(red_month,-(Month))
  
  mediter_mtc=mtc_index_calc(mediter_month,mediter_mean_tcode)
  red_mtc=mtc_index_calc(red_month,red_mean_tcode)
  
  plot(mediter_mtc,main=paste("Mediter Month", i ,"MTC"))
  plot(red_mtc,main=paste("Red Month", i ,"MTC"))
  
  #ggplot(mediter_mtc,aes(x=index,y=mtc))+geom_point() +ggtitle(paste("Mediter Month",i,"MTC")) 
  #ggplot(red_mtc, aes(x=index,y=mtc))+geom_point()+
  labs(subtitle = paste("Month",i),title = "Red sea Origin, MTC Vs Year")
   
  month_mediter_mtc=rbind(month_mediter_mtc,mediter_mtc)
  month_red_mtc=rbind(month_red_mtc,red_mtc)
}
month_mediter_mtc=cbind(month_mediter_mtc,"Month"=c (rep(1:12,each=(nrow(month_mediter_mtc))/12)))
month_red_mtc=cbind(month_red_mtc,"Month"=c(rep(1:12,each=(nrow(month_red_mtc))/12)))

```

#---seasonal mtc----
```{r}
 #call the season catch function
  season_all_catch=season_catch(all_data,species_code)

  #empety data frame for the loop
  season_all_mtc=data.frame()
  #season's names vector
  season=c("winter","spring","summer","autumn")
  
  #loop for the mtc in every season
  for (i in 1:4) {

    season_loop=season_all_catch[which(season_all_catch$Season ==season[i]),]
    season_loop=dplyr:: select(season_loop,-(Season))
    season_mtc=mtc_index_calc(season_loop,mean_tcode)
    plot(season_mtc,main=paste( season[i] ,"MTC"))
    season_all_mtc=rbind(season_all_mtc,season_mtc)
    }#end for
  season_all_mtc=cbind(season_all_mtc,"Season"= c(rep(season,each=(nrow(season_all_mtc)/4))))

  
  #start from 1991
  season_all_mtc=season_all_mtc[season_all_mtc$index %in% c(1991:2018),]
  season_all_mtc=dplyr:: rename(season_all_mtc,Year=index)
  
  #bind mean net temperature and mean depth - NA in the missing values 
  season_all_mtc=full_join(season_all_mtc,season_temp_depth,by=c("Year","Season"))
  
 
  
  #----season seperate by origin
  #call the season catch function
  season_mediter_catch=season_catch(mediter_all_data,mediter_code )
 season_red_catch=season_catch(red_all_data, red_code)   
 
 #season's names vector
 season=c("winter","spring","summer","autumn") 
 #empety data frame for the loop
 season_mediter_mtc=data.frame()
 season_red_mtc=data.frame()
  #loop for the mtc in everyseason to every origin
  for (i in 1:4) {
    mediter_season=season_mediter_catch[which(season_mediter_catch$Season==season[i]),]
    red_season=season_red_catch[which(season_red_catch$Season==season[i]),]
    
    mediter_season=dplyr:: select(mediter_season,-(Season))
    red_season=dplyr:: select(red_season,-(Season))
    
    mediter_mtc=mtc_index_calc(mediter_season,mediter_mean_tcode)
    red_mtc=mtc_index_calc(red_season,red_mean_tcode)
    
    plot(mediter_mtc,main=paste("Mediter", season[i] ,"MTC"))
    plot(red_mtc,main=paste("Red Sea", season[i] ,"MTC"))
    
    #ggplot(mediter_mtc,aes(x=index,y=mtc))+geom_point() +ggtitle(paste("Mediter",season[i],"MTC")) 
    #ggplot(red_mtc, aes(x=index,y=mtc))+geom_point()+
    #labs(subtitle = season[i],title = "Red sea Origin, MTC Vs Year")
    
   season_mediter_mtc=rbind(season_mediter_mtc,mediter_mtc)
   season_red_mtc=rbind(season_red_mtc,red_mtc)
  }
 season_mediter_mtc=cbind(season_mediter_mtc,"Season"=c (rep(season,each=(nrow(season_mediter_mtc)/4))))
 season_red_mtc=cbind(season_red_mtc,"Season"=c(rep(season,each=nrow(season_red_mtc)/4)))
  
 #start from 1991
 season_mediter_mtc=season_mediter_mtc[season_mediter_mtc$index %in% c(1991:2018),]
 season_red_mtc=season_red_mtc[season_red_mtc$index %in% c(1991:2018),]
 #season_mediter_mtc=rename(season_mediter_mtc,replace =  c("index"="Year"))
 season_mediter_mtc=rename(season_mediter_mtc,Year=index)
 #season_red_mtc=rename(season_red_mtc,replace =  c("index"="Year"))
 season_red_mtc=rename(season_red_mtc,Year=index)
 
 #bind mean net temperature and mean depth - NA in the missing values 
 season_mediter_mtc=full_join(season_mediter_mtc,season_temp_depth,by=c("Year","Season"))
 season_red_mtc=full_join(season_red_mtc,season_temp_depth,by=c("Year","Season"))
 
#mesiter seasons graphs
 ggplot(season_mediter_mtc[season_mediter_mtc$Season=="winter",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("Winter Mediterranian species MTC by mean net temperature")
 
    ggplot(season_mediter_mtc[season_mediter_mtc$Season=="winter",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("Winter Mediterranian species MTC by mean net depth")
 
 ggplot(season_mediter_mtc[season_mediter_mtc$Season=="spring",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("spring Mediterranian species MTC by mean net temperature")

    ggplot(season_mediter_mtc[season_mediter_mtc$Season=="spring",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("spring Mediterranian species MTC by mean net depth")

 ggplot(season_mediter_mtc[season_mediter_mtc$Season=="summer",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("summer Mediterranian species MTC by mean net temperature")
 
    ggplot(season_mediter_mtc[season_mediter_mtc$Season=="summer",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("summer Mediterranian species MTC by mean net depth")
 
 ggplot(season_mediter_mtc[season_mediter_mtc$Season=="autumn",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("autumn Mediterranian species MTC by mean net temperature")

    ggplot(season_mediter_mtc[season_mediter_mtc$Season=="autumn",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("autumn Mediterranian species MTC by mean net depth")
 

#red sea seasons graphs

     ggplot(season_red_mtc[season_red_mtc$Season=="winter",], aes(x=SST,y=mtc,colour=Year))+
    geom_point()+
    ggtitle("Winter red sea species MTC by mean net temperature")

     ggplot(season_red_mtc[season_red_mtc$Season=="winter",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("Winter red sea species MTC by mean net depth")
 
 ggplot(season_red_mtc[season_red_mtc$Season=="spring",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("spring red sea species MTC by mean net temperature")

    ggplot(season_red_mtc[season_red_mtc$Season=="spring",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("spring red sea species MTC by mean net depth")
 
 ggplot(season_red_mtc[season_red_mtc$Season=="summer",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("summer red sea species MTC by mean net temperature")

    ggplot(season_red_mtc[season_red_mtc$Season=="summer",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("summer red sea species MTC by mean net depth")
 
 ggplot(season_red_mtc[season_red_mtc$Season=="autumn",], aes(x=SST,y=mtc,colour=Year))+
   geom_point()+
   ggtitle("autumn red sea species MTC by mean net temperature")

    ggplot(season_red_mtc[season_red_mtc$Season=="autumn",], aes(x=Year,y=mtc,colour=Depth))+
      geom_point()+
      ggtitle("autumn red sea species MTC by mean net depth")
 

 
```

#----net mtc----
```{r}
 #drop the useless data for the mtc function
  species_code=rownames(mean_tcode)
  net_all_data=dplyr:: select(all_data,X,species_code)

  #calling mtc function
  net_mtc=mtc_index_calc(net_all_data,mean_tcode)
  net_all_data=cbind(all_data,"mtc"=net_mtc$mtc)
  
  write.csv(net_all_data,"prosseced data/net_mtc_data.CSV")
  
 # plot(net_all_data$Year,net_all_data$mtc)
  
 
 ggplot(net_all_data, aes(x=Year,y=mtc,colour=loc_DEPTH))+
   geom_point()+
   ggtitle("NET'S MTC by Year")+xlab("Year")  

 #--- net mtc by origin---
  #mediter mtc
  #drop the useless data for the mtc function
      net_mediter_data=dplyr:: select(mediter_all_data,X,mediter_code)

  #calling mtc function
    net_mediter_mtc=mtc_index_calc(net_mediter_data,mediter_mean_tcode)
      net_mediter_data=cbind(mediter_all_data,"mtc"=net_mediter_mtc$mtc)
  
    write.csv(net_mediter_data,"prosseced data/mediter_net_mtc.CSV")
    
    #red mtc
  #drop the useless data for the mtc function
      net_red_data=dplyr:: select(red_all_data,X,red_code)

  #calling mtc function
    net_red_mtc=mtc_index_calc(net_red_data,red_mean_tcode)
      net_red_data=cbind(red_all_data,"mtc"=net_red_mtc$mtc)
  
    write.csv(net_red_data,"prosseced data/red_net_mtc.CSV")

```





#----------GAM model ----------------------------#

```{r}

#----the whole data GAm model---
net_all_data = read.csv("prosseced data/net_mtc_data.CSV")


#get out rows without mtc
net_all_data = net_all_data %>%  dplyr:: filter(!is.na(mtc))

#gam model
gam_year = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") ,data = net_all_data)

#plot(gam_year,select = 2,shade = TRUE):plot(fitted(gam_year),residuals(gam_year))

par(mfrow = c(2,2)) 
plot(gam_year,se=TRUE,col = "blue")


#---seperate by origin---

#upload mediter and re sea data.
net_mediter_mtc = read.csv("prosseced data/mediter_net_mtc.CSV")
net_red_mtc = read.csv("prosseced data/red_net_mtc.CSV")

#get out rows without mtc
  net_mediter_mtc = net_mediter_mtc %>%  dplyr:: filter(!is.na(mtc))
  net_red_mtc = net_red_mtc %>%  dplyr:: filter(!is.na(mtc))
  
  # #set the date to numeric date tipe
  # net_mediter_mtc$Date = as_datetime(net_mediter_mtc$Date, origin = lubridate::origin, tz = "UTC")
  # net_red_mtc$Date = as_datetime(net_red_mtc$Date, origin = lubridate::origin, tz = "UTC")
  
 #create columns, "Season_num" of numbers from the seasons, for the model. winter=1, etc...    
  #ceate numeric columns frome the date-time "Date_num"
  net_mediter_mtc = net_mediter_mtc %>% mutate(Season_num = ifelse(Season=="winter", 1, ifelse(Season=="spring", 2, ifelse(Season=="summer", 3, ifelse(Season=="autumn", 4, NA)))))%>% mutate(Date_num = as.numeric(Date)) %>% dplyr::select(X:Date,Date_num,Week:Season,Season_num ,everything())
  
  net_red_mtc = net_red_mtc %>% mutate(Season_num = ifelse(Season=="winter", 1, ifelse(Season=="spring", 2, ifelse(Season=="summer", 3, ifelse(Season=="autumn", 4, NA))))) %>% mutate(Date_num = as.numeric(Date)) %>% dplyr::select(X:Date,Date_num,Week:Season,Season_num ,everything())
 
  #prepare data for joining: put origin column and delete catch columns
  split_mediter_mtc = net_mediter_mtc %>% mutate(Origin = "med") %>% dplyr::select(-(Aal:WHT))
    split_red_mtc = net_red_mtc %>% mutate(Origin = "red") %>% dplyr::select(-(Nra:Upo))
  
  split_all_mtc = rbind(split_mediter_mtc,split_red_mtc)
  
  
  #gam model
mediter_gam_year = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") ,data = net_mediter_mtc)
red_gam_year = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") ,data = net_red_mtc)

#plots

par(mfrow = c(2,2)) 
  plot(mediter_gam_year,se=TRUE,col = "blue")
  mtext("Mediterranean", side = 3, line = -2, outer = TRUE)
  plot(red_gam_year,se=TRUE,col = "blue")
  mtext("Red Sea", side = 3, line = -13.5, outer = TRUE)
  
  
  #---seaon model
  #clear memory
  gc()

  
  mediter_gam_season = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") + s(Season_num, bs = "cc", k=4) +s(Date_num, bs = "gp"),data = net_mediter_mtc)
   # +s(Date_num, bs = "gp")
  
red_gam_season = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") + s(Season_num, bs = "cc", k=4)+s(Date_num, bs = "gp") ,data = net_red_mtc)


par(mfrow = c(2,2)) 
  plot(mediter_gam_season,se=TRUE,col = "blue")
  title("Mediterranean",line = -2, outer=TRUE)
  
par(mfrow = c(2,2)) 
  plot(red_gam_season,se=TRUE,col = "blue")
   title("Red Sea",line = -2, outer=TRUE)
  
  #---month model
  mediter_gam_month = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") + s(Month, bs = "cc", k=12)+s(Date_num, bs = "gp") ,data = net_mediter_mtc)
  # 
  red_gam_month = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH, bs = "ad") + s(Month, bs = "cc", k=12)+s(Date_num, bs = "gp") ,data = net_red_mtc)
#
  
par(mfrow = c(2,2)) 
  plot(mediter_gam_month,se=TRUE,col = "blue")
title("Mediterranean",line = -2, outer=TRUE)
 
par(mfrow = c(2,2)) 
  plot(red_gam_month,se=TRUE,col = "blue") 
  title("Red Sea",line = -2, outer=TRUE)

  
  split_all_mtc$Origin =as.factor( split_all_mtc$Origin)
    split_gam_month = gam(mtc ~ s(Year, bs = "cr") + s(loc_DEPTH) + s(Month, bs = "cc", k=12) ,data = split_all_mtc,subset = origin)
#
  
par(mfrow = c(2,2)) 
  plot(split_gam_month,se=TRUE,col = "blue")
title("All split",line = -2, outer=TRUE)



```




#---------------------fenology-----------------------------------------------------------------------------

uploud the whole fish data
```{r}
#uploud fishes data 
all_data_unfilter=read.csv(file = "prosseced data/all_data_fishes_only.csv", stringsAsFactors = F)
 scientific_names_unfilter=read.csv(file = "prosseced data/sceintific_names_fishes_only.csv", stringsAsFactors = F)
#cerate species names vector
 sp_code_unfiletr=scientific_names_unfilter$Sp_code
 scientific_code_unfilter=scientific_names_unfilter$scintific_name

 # #set NA to FALSE and remove gamberi nets

  all_data_unfilter = all_data_unfilter %>% replace_na(list(Gambari_net=FALSE)) %>% dplyr::filter(Gambari_net=="FALSE")
 
```


catch graphs
```{r}

#call the monthly catch function
 month_catch_unfilter=month_catch(all_data_unfilter,sp_code_unfiletr)
#begen in 1987
 month_catch_unfilter=month_catch_unfilter[month_catch_unfilter$Year %in% c(1987:2018),] 
 
#create data frame for any quart of the years
month_catch_unfilter_a=  month_catch_unfilter[month_catch_unfilter$Year %in% c(1987:1994),]
month_catch_unfilter_b=  month_catch_unfilter[month_catch_unfilter$Year %in% c(1995:2002),]
month_catch_unfilter_c=  month_catch_unfilter[month_catch_unfilter$Year %in% c(2003:2010),]
month_catch_unfilter_d=  month_catch_unfilter[month_catch_unfilter$Year %in% c(2011:2018),]
 
#
for (i in 1:length(sp_code_unfiletr)) {
  
#make a single graph for any quart of the years
  p1= ggplot(month_catch_unfilter_a, aes(x=Month, y=month_catch_unfilter_a[,sp_code_unfiletr[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  
  p2=ggplot(month_catch_unfilter_b, aes(x=Month, y=month_catch_unfilter_b[,sp_code_unfiletr[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  p3=ggplot(month_catch_unfilter_c, aes(x=Month, y=month_catch_unfilter_c[,sp_code_unfiletr[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  p4=ggplot(month_catch_unfilter_d, aes(x=Month, y=month_catch_unfilter_d[,sp_code_unfiletr[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
 #ceate one graph included 4 graphs for any species
  #grid.arrange(p1, p3, p2, p4,ncol=2)
  grid.arrange(p4)
  
  #if saving without the "g" part, save just 1 of the 4, but in high resolution
  #so it's better for papars. [could order them by nyself after]
  #order for saving
  #g <- arrangeGrob(p1, p3, p2, p4, nrow=2) #generates g
  #ggsave(file = paste (sp_code_unfiletr[i],"png",sep ="."),g)

  }#end for
 

```


weekly normalization
```{r}
 
  #cerate date column
  all_data_unfilter$Date<-paste(all_data_unfilter$Year,all_data_unfilter$Month,all_data_unfilter$Day,sep = "-")
    #order the column by year month day
    all_data_unfilter$Date<-ymd(all_data_unfilter$Date)
      #create week column - the number of the week in th year
      all_data_unfilter$Week<-week(all_data_unfilter$Date)
      
      all_data_unfilter=all_data_unfilter[!is.na(all_data_unfilter$Month),]
      all_data_unfilter=all_data_unfilter[!is.na(all_data_unfilter$Week),]
      
      
      #create week ID coulmn wich I can count - year/month/week
      all_data_unfilter$Week_ID = with(all_data_unfilter,paste(Year,Month,Week,sep = "/"))
      #count how many nets in every week [count Week ID]
      week_count=all_data_unfilter %>% group_by(Week_ID) %>% summarise(count=n()) 

      
 
    #take the week_ID and species
    week_data= dplyr:: select(all_data_unfilter,Week_ID,Aal:WHT)
    #sum of weekly catch of each speceis: aggergate by ID
   week_data=week_data %>% group_by(Week_ID) %>% summarise_all(funs(sum))

    #create weekly mean catch:diviate the weekly sum of catch of each species in the 
    #sum of nets in the week
    week_data=week_data %>% dplyr:: select(Aal:WHT)   
    week_data=week_data/week_count$count  
    
    #seperate the Id string to Year and Week and bind to "week data"
    week_id_sep=week_count %>% separate(Week_ID,c("Year","Month","Week"))
    week_data=cbind("Week_ID"= week_count$Week_ID,"Year"=week_id_sep$Year,"Week"=week_id_sep$Week ,week_data)

    week_data$Week=as.numeric(as.character(week_data$Week))  
    week_data$Year=as.numeric(as.character(week_data$Year))
   
  
   
    
        
    #begen in 1987
    week_data=week_data[week_data$Year %in% c(1987:2018),] 
    
    #create data frame for any quart of the years
    week_data_a=  week_data[week_data$Year %in% c(1987:1994),]
    week_data_b=  week_data[week_data$Year %in% c(1994:2002),]
    week_data_c=  week_data[week_data$Year %in% c(2001:2010),]
    week_data_d=  week_data[week_data$Year %in% c(2007:2018),]
    


```

graphs of the ratio catch

```{r}
 
    
    for (i in 1:length(sp_code_unfiletr)) {
      
      #make a single graph for any quart of the years
      p1= ggplot(week_data_a, aes(x=Week, y=week_data_a[,sp_code_unfiletr[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      
      p2=ggplot(week_data_b, aes(x=Week, y=week_data_b[,sp_code_unfiletr[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      p3=ggplot(week_data_c, aes(x=Week, y=week_data_c[,sp_code_unfiletr[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      p4=ggplot(week_data_d, aes(x=Week, y=week_data_d[,sp_code_unfiletr[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_code_unfiletr[i],scientific_code_unfilter[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      
      #ceate one graph included 4 graphs for any species
  grid.arrange(p1, p3, p2, p4,ncol=2)
      
      #save the graphs - !!set the directory before use!!
      #if saving without the "g" part, save just 1 of the 4, but in high resolution
      #so it's better for papars. [could order them by myself after]
        #order for saving
        #g <- arrangeGrob(p1, p3, p2, p4, nrow=2) #generates g
        g <- arrangeGrob( p4) #generates g
        ggsave(file = paste (sp_code_unfiletr[i],"png",sep ="."),g)
      
    }#end for

```



#----------- b size ----------------- 


```{r}

#It is just on 2013_2018 data, need to check what in Itay data

#uploud data
size_all_data = read.csv("data/kg_data_sizes.CSV")

#take just row with b siz = "Zair" only
b_size_all = size_all_data %>% dplyr::select(X:species,kg_b) %>% filter(!is.na(kg_b))

#list of the species has b size, and make it character
species_b = unique(b_size_all$species)
species_b = as.character(species_b)

#loop of graphs for any specy
for (i in 1:length(species_b))
{
  tepm_b_species = b_size_all %>% dplyr::select(Year.XXXX.,Month.XX.,species,kg_b) %>% filter(species == species_b[i])

    
    
      
      p=ggplot(tepm_b_species, aes(x=Month.XX., y=kg_b,color=Year.XXXX. )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year.XXXX.~.)+ggtitle(species_b[i])+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
    grid.arrange(p)
}  
  
```

