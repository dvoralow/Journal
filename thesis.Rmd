---
title: "Thesis"
output: html_document
editor_options: 
  chunk_output_type: console
---

Ctrl+Alt+i make new chunk



all the libraries required to the whole code:
```{r}

library(dplyr)
library(tidyverse)
library(devtools)
library(gridExtra)
library(ggplot2)
library(jcolors)
library(RColorBrewer)
library(lubridate)
library(mgcv)
library(quantmod)
library(viridis)
library("reshape2")
library(mgcViz)
library(curl)
library(DataCombine)
library(nlme)
library(ggpubr)


```
end code


#----- edit daily SST from copernicus model-----
I extract daily sst from Copernicus model, between 1991-2018

```{r}
sst = read.csv("data/daily SST model 1991_2018.CSV")

#convert from K C degree
sst = sst %>% dplyr:: mutate(Ashdod_sst = Ashdod_sst-273, Jaffa_sst = Jaffa_sst-273, Michmoret_sst = Michmoret_sst-273)

sst =sst %>%  dplyr::mutate(Date = (dmy(paste0("1/1/",sst$Year))  + sst$Day - 1)) %>% dplyr::mutate(Month = lubridate::month(Date)) %>% dplyr::select(Date, Year, Month, Day, Ashdod_sst)
sst_date = sst %>% dplyr::select(Date,"SST" = Ashdod_sst) 

```



clean the data - no need to run every time

```{r eval=FALSE, include=FALSE}
 #put the net temperautre into the all_data
        #all_data=read.csv(file=paste(thesis_directory,"all_data.csv",sep = "/"),stringsAsFactors = F)
        #all_data=cbind(all_data,"Temp"=net_temp$temp)
        #write.csv(all_data,file = paste(thesis_directory,"all_data.csv",sep = "/") )=
  #names of shrimps, crabs, octopus, squids - cod names.
  drops_no_fish <- c("Lvu","Ovu","Plo","Sof","Mae","Pja","Pse")
  #names of fishes with unknown origin and general category with no speceis
  drops_no_origin=c("Ccr","MUL_UP","Sma","BOX","FIS","SPL","TRA","Eer","SAR","SPH","Sud","Sha")

  #upload the dataframes
  all_data=read.csv(file="data/final_data_1987_2018.csv", stringsAsFactors = F)
  scientific_names=read.csv(file = "data/species_scientific_name.csv" ,stringsAsFactors = F)
  species_names_seperate=read.csv(file = "data/species name_seperate.csv",stringsAsFactors = F)
  t_pref=read.csv(file = "prosseced data/mean_temp_pref_cheung.csv",stringsAsFactors = F)
  

 
  #sort to alepahbeta order by sp_cod - the 'all_data' and 'scientific_names' are alrady sorted
  species_names_seperate=species_names_seperate[order(species_names_seperate$Sp_code),]

  #drop the duplicates species [chaneg in their prices only]
  scientific_names=scientific_names[!duplicated(scientific_names$Sp_code),]

  
  #join season and date to all_data
  #cerate date column
  all_data$DateTime<-paste(all_data$Year,all_data$Month,all_data$Day,all_data$Start_hh,sep = "-")
  all_data$Date<-paste(all_data$Year,all_data$Month,all_data$Day,sep = "-")
    #order the column by year month day
    all_data$DateTime<-ymd_h(all_data$DateTime)
    all_data$Date = ymd(all_data$Date)
      #create week column - the number of the week in th year
      all_data$Week<-week(all_data$Date)
    
      season_data = data.frame("Season" = rep(c("winter","spring", "summer", "autumn"),each = 3),"Month" = c(12,1:11))
      
 all_data = left_join(all_data,season_data, by = "Month") 
 all_data = all_data %>% left_join(sst_date, by = "Date") %>% dplyr::select(X:Day,DateTime,Date:Season,SST,everything())
all_data =all_data %>% dplyr::mutate(Season_num = ifelse(Season=="winter", 1, ifelse(Season=="spring", 2, ifelse(Season=="summer", 3, ifelse(Season=="autumn", 4, NA))))) %>% dplyr::select(X:Season, Season_num, everything())


#remove uncorrect depthes
all_data = all_data %>% dplyr::mutate(depth_meter = replace(depth_meter,depth_meter < 10, NA)) %>% dplyr::mutate(depth_meter = replace(depth_meter, depth_meter > 1000, NA))


  #remove not fishes [alredy removed from 'speceis_names_seperate']
  all_data =all_data[ , !(names(all_data) %in% drops_no_fish)]
    write.csv(all_data,file = "prosseced data/all_data_fishes_only.csv")
  scientific_names=scientific_names[!(scientific_names$Sp_code%in%drops_no_fish),]
    write.csv(scientific_names,file ="prosseced data/sceintific_names_fishes_only.csv") 

  #remove no origin
  all_data=all_data[,!(names(all_data)%in% drops_no_origin)]
    write.csv(all_data,file = "prosseced data/all_data_fishes_known_origin.csv")
  
    scientific_names=scientific_names[!(scientific_names$Sp_code %in% drops_no_origin),]
    write.csv(scientific_names,file = "prosseced data/sceintific_names_fishes_known_origin.csv" )
  
    species_names_seperate=species_names_seperate[!(species_names_seperate$Sp_code%in%drops_no_origin),]
    write.csv(species_names_seperate,file = "prosseced data/species_names_seperate_fish_known_origin.csv" )
  
    t_pref=t_pref[!(t_pref$sp_code%in%drops_no_origin),]
    write.csv(t_pref,file = "prosseced data/mean_temp_prefference.csv")
    


``` 
end chunk


#--------------------functions--------------------------------------------------
1.annual catch
2.MTC index
3.monthly agragation the data
4.seasonal agregate the data

```{r}
#----1. annual catch----
#This function get 1 data frame and 1 vector: 
# data with "Year" and abundence of species in every net.
# vector with the sp_code names that are in the data    
#return dataframe with 1 row for any year, with annual cath [sum]
#the old code for this function is in "mtc_function", I dont think its useful
annual_catch=function(the_big_data,code){
    
    filter_data=dplyr::select(the_big_data,Year,code)
    filter_data=aggregate.data.frame(filter_data,list(filter_data$Year),FUN = sum,drop=F)
    filter_data=dplyr:: select(filter_data,Year=Group.1,code ) 
    return(filter_data)
  }
  

#-------2. MTC index-------

#input:
  #2 data frames: 
    #1. time index [year/month/season] in the first column, sum of catch for the time series, to any speicies
    #2. data with the same speceies and same order as 1, with column called "Tpref"
      #with the species prefernce temperature

#output:
  #dataframe with the time sereies and the mtc index of thes time series.
  #if one index had no caths, mtc=NA
mtc_index_calc=function(time_species_data,sp_tpref_data){
 #create a vector from the time index, and remove the time column form datafarme
  time_index=time_species_data[,1]
  time_species_data=time_species_data[,2:ncol(time_species_data)]
   #data frame with species names and Tpreference
     mtc_data=time_species_data[1,]
     mtc_data=mtc_data[0,]
     #put Tpref into mtc_data
     mtc_data[1,]=sp_tpref_data$Tpref
  
  #data frame with index name and mtc name
     mtc=data.frame("index"=NA,
                 "mtc"=NA)
    
  #loop - calculate MTC index
     for (i in 1:nrow(time_species_data)) {
      #put annual catch into mtc_data
       mtc_data[2,]=time_species_data[i,1:ncol(time_species_data)]
       #multiple annual catch*tpref of any species
       mtc_data[3,]=mtc_data[1,]*mtc_data[2,]
    
      mtc[i,2]=sum(mtc_data[3,])/sum(mtc_data[2,])
      mtc[i,1]=time_index[i]
    
     }
     
  return(mtc)
}

  
#---3. monthly agragation the data----
    #This function get 1 data frame and 1 vector: 
    # data with "Year" and abundence of species in every net.
    # vector with the sp_code names that are in the data  
    #return dataframe with 12 rows for each year, with month catch for every month [sum]
    
  month_catch=function(the_big_data,code){
   
  #take just the relevant column 
  filter_data=select(the_big_data,Year,Month,code)
    #sum the cathc by month by year
    filter_data=aggregate.data.frame(filter_data,list(filter_data$Year,filter_data$Month),FUN = sum,drop=F)
    #rename the new column and drop sum of years and month   
    filter_data=select(filter_data,Year=Group.1,Month=Group.2,code ) 
   return(filter_data)
  }
 



#---4. seasonal agregate the data 
 season_catch=function(the_big_data,code)
   {
#take just the relevant column 
  filter_data=dplyr::select(the_big_data,Year,Season_num,code)
    #sum the catch by  by year
    filter_data=aggregate.data.frame(filter_data,list(filter_data$Year,filter_data$Season_num),FUN = sum,drop=F)
    #rename the new column and drop sum of years and Season   
    filter_data=select(filter_data,Year=Group.1,Season_num=Group.2,code ) 
   return(filter_data)
  }
 
  
```
end chunk


#-------------------mtc calculations--------------------------------------------------------

 #----calcualte t prefference for spceis and for sp_code---

```{r}

   #the mean prefference temperature for every species - Cheung t_pref combined with myn
    t_pref=read.csv(file= "prosseced data/mean_temp_pref_cheung.csv",stringsAsFactors = F)
   
      
    
    #loop for calculating the mean temperature for every sp_code - form the mean t_pref
    #sp_code is the fisheries names, which include some species togther
    species_code<-unique(t_pref$sp_code)
    mean_tcode<-c()
    
    for (i in 1:length(species_code)
    ) {
      
      calc_data=subset(t_pref,sp_code==species_code[i])
      mean_data=mean(calc_data$Tpref)
      mean_tcode=rbind(mean_tcode,mean_data)
      
    }#end for
    row.names(mean_tcode)=unique(species_code)
    colnames(mean_tcode)=c("Tpref")
    
    #change the lokus temp to be by Epinephelus aeneus, instead of mean
    mean_tcode["EPI",]= t_pref$Tpref[t_pref$X=="Epinephelus aeneus"]
    
    #different percent for dipoldus, Mullus, Spicara, Batiodea, and Siganus
    dip=t_pref[t_pref$sp_code=="DIP",]
    sum_dip=sum(dip$Tpref_percent)
    mean_tcode["DIP",]=sum_dip
    
    mull=t_pref[t_pref$sp_code=="MUL",]
    sum_mull=sum(mull$Tpref_percent)
    mean_tcode["MUL",]=sum_mull
    
    spi=t_pref[t_pref$sp_code=="SPI",]
    sum_spi=sum(spi$Tpref_percent)
    mean_tcode["SPI",]=sum_spi
    
    bat=t_pref[t_pref$sp_code=="BAT",]
    sum_bat=sum(bat$Tpref_percent)
    mean_tcode["BAT",]=sum_bat
    
    sig=t_pref[t_pref$sp_code=="Sig",]
    sum_sig=sum(sig$Tpref_percent)
    mean_tcode["Sig",]=sum_sig
    
    #calculate the temperature of WHT code, and join it to mean_tcode data
    wht_temp=0.8*mean_tcode["DIP",]+0.2*mean_tcode["Lmo",]
    wht_temp=as.data.frame(wht_temp)
    row.names(wht_temp)="WHT"
    colnames(wht_temp)="Tpref"
    mean_tcode=rbind(mean_tcode,wht_temp)
    mean_tcode = mean_tcode[sort(rownames(mean_tcode)),,drop = F]
    
    write.csv(mean_tcode,file = "prosseced data/mean_tcode.CSV")
    
    
```



#----mean month, season and year net temperature and depth----
```{r}

   #----mean month, season and year net temperature and depth----
    all_data=read.csv(file= "prosseced data/all_data_fishes_known_origin.csv", stringsAsFactors = F)
    #-- mean year temp
    #select yaer and temperature column
    year_temp= dplyr:: select(all_data,Year,SST)
    #remove 0 and NA rows
    year_temp=year_temp[year_temp$SST!=0,]
    year_temp=na.omit(year_temp)
    #mean of the temperature
    year_temp=aggregate.data.frame(year_temp,list(year_temp$Year),FUN = mean,drop=F)
    year_temp=select(year_temp,Year,SST )
     
    
    #---yearly mean SST and SST anomaly
    
    yearly_mean_sst = mean(year_temp$SST)
    year_temp = year_temp %>% mutate("SST_anom" = SST-yearly_mean_sst)
    
    #mean year depth
    year_depth= dplyr:: select(all_data,Year,depth_meter)
    year_depth=year_depth[year_depth$depth_meter!=0,] 
    year_depth=na.omit(year_depth) 
    year_depth=aggregate.data.frame(year_depth,list(year_depth$Year),FUN = mean,drop = F)
    year_depth=dplyr:: select(year_depth,Year,depth_meter)
    #start year depth in 1991
    year_depth=year_depth[year_depth$Year %in% 1991:2018,]
    #bind the temperature and depth
   year_temp_depth=cbind(year_temp,"Depth"=year_depth$depth_meter)
  
     plot(year_depth)
    plot(year_temp)
    
    
  
    
    
#--mean month depth and temperature
    month_depth=dplyr:: select(all_data,Year,Month,depth_meter)
    
    
    #remove 0 and NA
    month_depth=na.omit(month_depth)
    month_depth=month_depth[month_depth$depth_meter!=0,]
    #aggregate by year by month
    month_depth=aggregate.data.frame(month_depth,list(month_depth$Year,month_depth$Month),FUN = mean,drop = F)
    month_depth=na.omit(month_depth)
    month_depth=dplyr:: select(month_depth,Year=Group.1,Month=Group.2,Depth=depth_meter)
    month_depth=month_depth[month_depth$Year %in% c(1991:2018),]
    
    #mean month net temperature - same as month depth [seperate because the NA rows doesn't equal]
    month_temp=dplyr:: select(all_data,Year,Month,SST)
    month_temp=na.omit(month_temp)
    month_temp=month_temp[month_temp$SST!=0,]
    month_temp=aggregate.data.frame(month_temp,list(month_temp$Year,month_temp$Month),FUN=mean,drop = F)
    month_temp=na.omit(month_temp)
    month_temp=dplyr:: select(month_temp,Year=Group.1,Month=Group.2,SST)

    
    month_temp_depth=cbind(month_temp,Depth=month_depth$Depth)
     
    
#---mean season depth and temperature
     season_depth=dplyr:: select(all_data,Year,Season_num,depth_meter)
    #remove 0 and NA
    season_depth=na.omit(season_depth)
    season_depth=season_depth[season_depth$depth_meter!=0,]
    #aggregate by year by season
    
   
    season_depth = aggregate.data.frame(season_depth,list(season_depth$Year,season_depth$Season_num),FUN = mean,drop = F)
     season_depth=season_depth[season_depth$Year %in% c(1991:2018),]
    season_depth=na.omit(season_depth)
    season_depth=dplyr:: select(season_depth,Year,Season_num,Depth=depth_meter)
   
    
    #mean season net temperature - same as season depth [seperate because the NA rows doesn't equal]
    season_temp=dplyr:: select(all_data,Year,Season_num,SST)
    season_temp=na.omit(season_temp)
    season_temp=season_temp[season_temp$SST!=0,]
    
       #---season mean SST and SST anomaly
    #for any season - take the season data, make mean of SST for each year, compute mean single SST value [from the whole years]
    #and create SST amonaly column - the difference between seasonal SST and the single mean SST value.
     winter_temp =season_temp %>% dplyr::filter(Season_num ==1) 
      winter_temp = winter_temp %>% aggregate.data.frame(list(winter_temp$Year,winter_temp$Season_num),FUN=mean,drop = F) %>% dplyr::select(Year, Season_num, SST) %>% mutate("SST_anom" = SST - mean(SST))
     
     spring_temp =season_temp %>% dplyr::filter(Season_num ==2) %>% mutate("SST_anom" = SST - mean(SST))
       spring_temp = spring_temp %>% aggregate.data.frame(list(spring_temp$Year,spring_temp$Season_num),FUN=mean,drop = F) %>% dplyr::select(Year, Season_num, SST) %>% mutate("SST_anom" = SST - mean(SST))
     
     summer_temp =season_temp %>% dplyr::filter(Season_num ==3) %>% mutate("SST_anom" = SST - mean(SST))
      summer_temp = summer_temp %>% aggregate.data.frame(list(summer_temp$Year,summer_temp$Season_num),FUN=mean,drop = F) %>% dplyr::select(Year, Season_num, SST) %>% mutate("SST_anom" = SST - mean(SST))
     
     automn_temp =season_temp %>% dplyr::filter(Season_num ==4) %>% mutate("SST_anom" = SST - mean(SST))
       automn_temp = automn_temp %>% aggregate.data.frame(list(automn_temp$Year,automn_temp$Season_num),FUN=mean,drop = F) %>% dplyr::select(Year, Season_num, SST) %>% mutate("SST_anom" = SST - mean(SST))

   #bind the seasons to 1 data frame, join with the depth, and create Season column - the names ["winter", inc.] instead of numbers
     season_temp = rbind(winter_temp,spring_temp,summer_temp,automn_temp)

    season_temp_depth=cbind(season_temp,Depth=season_depth$Depth)

          season_temp_depth =season_temp_depth %>% dplyr::mutate(Season = ifelse(Season_num==1,"winter", ifelse(Season_num==2, "spring", ifelse(Season_num==3, "summer", ifelse(Season_num==4, "autumn", NA))))) 
    
    

```


#--- calling annual catch function---
```{r}
 species_to_scientific_name=read.csv(file= "prosseced data/sceintific_names_fishes_known_origin.csv" ,stringsAsFactors = F)
  all_data=read.csv(file= "prosseced data/all_data_fishes_known_origin.csv",stringsAsFactors = F)
  species_code<-unique(species_to_scientific_name$Sp_code)  
  annual_sp_catch=annual_catch(all_data,species_code)
    
  write.csv(annual_sp_catch,file = "prosseced data/annual_catch.csv")
    
  

```
 

    
#---calling mtc function---
```{r}
annual_mtc=mtc_index_calc(annual_sp_catch,mean_tcode)
#start from 1991
annual_mtc=annual_mtc[annual_mtc$index %in% c(1991:2018),]
year_depth = year_depth[year_depth$Year %in% c(1991:2018),]

#bind mean net temperature and mean depth
annual_mtc=cbind("mtc"=annual_mtc$mtc,year_temp_depth)


# plot(annual_mtc,main="annual mtc")
# 
# ggplot(annual_mtc, aes(x=depth_meter,y=mtc,colour=Year, size=5))+
#   geom_point()+scale_color_brewer(palette="
#                                   Reds")+
#   ggtitle("Annual Catch MTC by mean net temperature")
# 
# 
# 
# #ggplot(annual_mtc, aes(x=Year,y=mtc,colour=depth_meter, size=3))+
#   geom_point()+
#   ggtitle("Annual catch MTC by year")
# 
# #scale_color_brewer(palette="Dark2")

```

#--seperate mediterrinian and red sea species
```{r}
species_to_scientific_name=read.csv(file= "prosseced data/sceintific_names_fishes_known_origin.csv",stringsAsFactors = F)
all_data=read.csv(file="prosseced data/all_data_fishes_known_origin.csv" ,stringsAsFactors = F)

#sp_code of the mediterrinian and red sea origin 
mediter_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Med"),"Sp_code"]
red_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Red"),"Sp_code"]

#split all_data to the mediterriania and the red sea origin
mediter_all_data=all_data[,which(!(colnames(all_data) %in% red_code))]
red_all_data=all_data[,which(!(colnames(all_data) %in% mediter_code))]

#create Tpref seperate for mediterrianian and red sea origin
mediter_mean_tcode=as.data.frame( mean_tcode[which(!(rownames(mean_tcode) %in% red_code)),])
rownames(mediter_mean_tcode)=mediter_code
colnames(mediter_mean_tcode)="Tpref"
red_mean_tcode=as.data.frame(mean_tcode[which(!(rownames(mean_tcode) %in% mediter_code)),])
rownames(red_mean_tcode)=red_code
colnames(red_mean_tcode)="Tpref"

#call to annual catch function
mediter_annual_catch=annual_catch(mediter_all_data,mediter_code)
red_annual_catch=annual_catch(red_all_data,red_code)

#call to mtc function 
mediter_annual_mtc=mtc_index_calc(mediter_annual_catch,mediter_mean_tcode)
red_annual_mtc=mtc_index_calc(red_annual_catch,red_mean_tcode)

#start in 1991 and bind mean net temperature and mean depth
mediter_annual_mtc=mediter_annual_mtc[mediter_annual_mtc$index %in% c(1991:2018),]
red_annual_mtc=red_annual_mtc[red_annual_mtc$index %in% c(1991:2018),]
mediter_annual_mtc=cbind("mtc"=mediter_annual_mtc$mtc,year_temp_depth)
red_annual_mtc=cbind("mtc"=red_annual_mtc$mtc,year_temp_depth)

mediter_annual_mtc=cbind("mtc"=mediter_annual_mtc$mtc,year_temp_depth)
red_annual_mtc=cbind("mtc"=red_annual_mtc$mtc,year_temp_depth)



# plot(mediter_annual_mtc, main="Mediterrinian Annual mtc")
# plot(red_annual_mtc,main="Red Annual mtc")
# 
#  ggplot(mediter_annual_mtc, aes(x=SST,y=mtc,colour=Year, size=3))+
#    geom_point()+
#    ggtitle("Annual Mediterranian species MTC by mean net temperature")
# 
#  ggplot(mediter_annual_mtc, aes(x=SST,y=mtc,colour=Depth))+
#    geom_point()+
#    ggtitle("Annual Mediterranian species MTC by mean net temperature")
# 
#  ggplot(mediter_annual_mtc, aes(x=Year,y=mtc,colour=SST, size=3))+
#    geom_point()+
#    ggtitle("Annual Mediterranian species MTC by year")
# 
#  ggplot(red_annual_mtc, aes(x=SST,y=mtc,colour=Year, size=3))+
#    geom_point()+
#    ggtitle("Annual Red sea species MTC by mean net temperature")
# 
#  ggplot(red_annual_mtc, aes(x=SST,y=mtc,colour=Depth))+
#    geom_point()+
#    ggtitle("Annual Red sea species MTC by mean net temperature")
# 
#  ggplot(red_annual_mtc, aes(x=Year,y=mtc,colour=SST, size=3))+
#    geom_point()+
#    ggtitle("Annual Red Sea species MTC by year")
#  
# 
# ggplot(red_annual_mtc, aes(x=Year,y=mtc,colour=Depth, size=3))+
#   geom_point()+
#   ggtitle("Annual Red Sea species MTC by year")
# 
# ggplot(mediter_annual_mtc, aes(x=Year,y=mtc,colour=Depth, size=3))+
#   geom_point()+
#   ggtitle("Annual Mediterranian species MTC by year")




  
```


#-----Yearly graphs for paper
```{r}

#formula <- y ~ poly(x, 2, raw = TRUE)
formula_l = y~x

#mediterranian graph
p1 = ggplot(mediter_annual_mtc, aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="Temperature affinity")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +
  #geom_line(aes(y = SST_anom+20.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(sec.axis = sec_axis(~.-20.5, name = "T anomaly"))+#create second axes to SST
  #ggtitle("Annual Mediterranian Species MTC By Year, Compare To SST Anomaly")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+20.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")+
geom_text(data =mediter_annual_mtc[mediter_annual_mtc$Year =="2004", ], aes(label = "T affinity"), hjust = -1.5,vjust = -0.5)+#label to lines - cheated
geom_text(data =mediter_annual_mtc[mediter_annual_mtc$Year =="1993", ], aes(label = "T anomaly"), hjust = -0.4,vjust = -3,color = "red")
  

#red sea graph
#p2 =  
  ggplot(red_annual_mtc, aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
 scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="Temperature affinity")+#axis text

  #geom_line(aes(y = SST_anom+26, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))+#x axis years apeared
  scale_y_continuous(breaks=seq(25.5,28, by =0.5), limits = c(25.5,28),sec.axis = sec_axis(~.-26.75, name = "T anomaly"))+#create second axes to SST
  #ggtitle("Annual Red Sea Species MTC By Year, Compare To SST Anomaly")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+26.75), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")+
geom_text(data =red_annual_mtc[red_annual_mtc$Year =="2008", ], aes(label = "T affinity"), hjust = -0.5,vjust = -9)+#label to lines - cheated
geom_text(data =red_annual_mtc[red_annual_mtc$Year =="1999", ], aes(label = "T anomaly"), hjust = 0.7,vjust = 18,color = "red")

 grid.arrange(p1,p2, ncol = 2)

```


#----- Annual biomass per net - graphs---
I think 2000 is good time for start for the invasive
```{r}
#create data frame with number of nets for any year
 annual_years =mediter_all_data  %>% group_by(Year) %>% summarise(count=n())

#create sum of the year catch, and devide with the number of nets
red_years = red_annual_catch %>% mutate(Sum = rowSums(.[2:7])) %>% left_join(annual_years) %>% mutate(Per_net = Sum/count)

mediter_years = mediter_annual_catch %>% mutate(Sum = rowSums(.[2:26]))%>% left_join(annual_years)%>% mutate(Per_net = Sum/count)
 
ggplot(red_years, aes(x=Year,y=Per_net, size=5))+
  geom_point(colour = "red", size = 7)+
  scale_size(guide = 'none')+#no legend to the "size"
   ggtitle("Invasive speicies biomass per net")+
 labs(y ="Annual Biomass  per net [kg]")+ #axis text
    theme(plot.title = element_text(size = 20,hjust = 0.5), axis.text.x = element_text(size = 15, angle=90, hjust=1), axis.text.y = element_text(size = 15, hjust=1), axis.title=element_text(size=14,face="bold"))+
scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))#x axis years apeared
 # scale_y_continuous(breaks=seq(0,20000, by =2000), limits = c(0,20000))
 

ggplot(mediter_years, aes(x=Year,y=Per_net, size=5))+
  geom_point(colour = "blue", size = 7)+
  scale_size(guide = 'none')+#no legend to the "size"
   ggtitle("Mediterranean speicies biomass per net")+
 labs(y ="Annual Biomass per net [kg]")+ #axis text
    theme(plot.title = element_text(size = 20,hjust = 0.5), axis.text.x = element_text(size = 15, angle=90, hjust=1), axis.text.y = element_text(size = 15, hjust=1), axis.title=element_text(size=14,face="bold"))+
scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))#x axis years apeared
  #scale_y_continuous(breaks=seq(0,20000, by =2000), limits = c(0,20000))

```



#----month mtc----
```{r}
      #---all_fishes
  #call the month catch function
  monthly_all_catch=month_catch(all_data,species_code)
 

month_all_mtc=data.frame()
#loop for the mtc in every month
  for (i in 1:12) {
  
    month_1=monthly_all_catch[which(monthly_all_catch$Month ==i),]
    month_1=dplyr:: select(month_1,-(Month))
    month_mtc=mtc_index_calc(month_1,mean_tcode)
   # plot(month_mtc,main=paste("Month", i ,"MTC"))
      
    
    #ggplot(month_mtc,aes(x=index,y=mtc))+geom_point()+ggtitle(paste("Month",i,"MTC"))
    
    month_all_mtc=rbind(month_all_mtc,month_mtc)
  }
month_all_mtc=cbind(month_all_mtc,"Month"= c(rep(1:12,each=((nrow(month_all_mtc))/12))))

    #----seperate by origin---
    #call the month catch function
  month_mediter_catch=month_catch(mediter_all_data,mediter_code )
month_red_catch=month_catch(red_all_data, red_code)   

month_mediter_mtc=data.frame()
month_red_mtc=data.frame()
#loop for the mtc in every month to every origin
for (i in 1:12) {
  mediter_month=month_mediter_catch[which(month_mediter_catch$Month==i),]
  red_month=month_red_catch[which(month_red_catch$Month==i),]
  
  mediter_month=dplyr:: select(mediter_month,-(Month))
  red_month=dplyr:: select(red_month,-(Month))
  
  mediter_mtc=mtc_index_calc(mediter_month,mediter_mean_tcode)
  red_mtc=mtc_index_calc(red_month,red_mean_tcode)
  
  #plot(mediter_mtc,main=paste("Mediter Month", i ,"MTC"))
  #plot(red_mtc,main=paste("Red Month", i ,"MTC"))
  
  #ggplot(mediter_mtc,aes(x=index,y=mtc))+geom_point() +ggtitle(paste("Mediter Month",i,"MTC")) 
  #ggplot(red_mtc, aes(x=index,y=mtc))+geom_point()+
  labs(subtitle = paste("Month",i),title = "Red sea Origin, MTC Vs Year")
   
  month_mediter_mtc=rbind(month_mediter_mtc,mediter_mtc)
  month_red_mtc=rbind(month_red_mtc,red_mtc)
}
month_mediter_mtc=cbind(month_mediter_mtc,"Month"=c (rep(1:12,each=(nrow(month_mediter_mtc))/12)))
month_red_mtc=cbind(month_red_mtc,"Month"=c(rep(1:12,each=(nrow(month_red_mtc))/12)))

```



#---seasonal mtc----
```{r}
 #call the season catch function
  season_all_catch=season_catch(all_data,species_code)
   season_all_catch =season_all_catch %>% dplyr::mutate(Season = ifelse(Season_num==1,"winter", ifelse(Season_num==2, "spring", ifelse(Season_num==3, "summer", ifelse(Season_num==4, "autumn", NA))))) %>% dplyr::select(Year,Season_num,Season,everything())

  #empety data frame for the loop
  season_all_mtc=data.frame()
  #season's names vector
  season=c("winter","spring","summer","autumn")
  
  #loop for the mtc in every season
  for (i in 1:4) {

    season_loop=season_all_catch[which(season_all_catch$Season_num ==i),]
    season_loop=dplyr:: select(season_loop,-(Season),-(Season_num))
    season_mtc=mtc_index_calc(season_loop,mean_tcode)
    #plot(season_mtc,main=paste( season[i] ,"MTC"))
    season_all_mtc=rbind(season_all_mtc,season_mtc)
    }#end for
  season_all_mtc=cbind(season_all_mtc,"Season"= c(rep(season,each=(nrow(season_all_mtc)/4))))

  
  #start from 1991
  season_all_mtc=season_all_mtc[season_all_mtc$index %in% c(1991:2018),]
  season_all_mtc=dplyr:: rename(season_all_mtc,Year=index)
  
  #bind mean net temperature and mean depth - NA in the missing values 
  season_all_mtc=full_join(season_all_mtc,season_temp_depth,by=c("Year","Season"))
  
 
  
  #----season seperate by origin
  #call the season catch function
  season_mediter_catch=season_catch(mediter_all_data,mediter_code )
 season_red_catch=season_catch(red_all_data, red_code)   
 
 #season's names vector
 
 #empety data frame for the loop
 season_mediter_mtc=data.frame()
 season_red_mtc=data.frame()
  #loop for the mtc in everyseason to every origin
  for (i in 1:4) {
    mediter_season=season_mediter_catch[which(season_mediter_catch$Season_num==i),]
    red_season=season_red_catch[which(season_red_catch$Season_num==i),]
    
    mediter_season=dplyr:: select(mediter_season,-(Season_num))
    red_season=dplyr:: select(red_season,-(Season_num))
    
    mediter_mtc=mtc_index_calc(mediter_season,mediter_mean_tcode)
    red_mtc=mtc_index_calc(red_season,red_mean_tcode)
    
   # plot(mediter_mtc,main=paste("Mediter", season[i] ,"MTC"))
    #plot(red_mtc,main=paste("Red Sea", season[i] ,"MTC"))
    
    #ggplot(mediter_mtc,aes(x=index,y=mtc))+geom_point() +ggtitle(paste("Mediter",season[i],"MTC")) 
    #ggplot(red_mtc, aes(x=index,y=mtc))+geom_point()+
    #labs(subtitle = season[i],title = "Red sea Origin, MTC Vs Year")
    
   season_mediter_mtc=rbind(season_mediter_mtc,mediter_mtc)
   season_red_mtc=rbind(season_red_mtc,red_mtc)
  }
 season_mediter_mtc=cbind(season_mediter_mtc,"Season"=c (rep(season,each=(nrow(season_mediter_mtc)/4))))
 season_red_mtc=cbind(season_red_mtc,"Season"=c(rep(season,each=nrow(season_red_mtc)/4)))
  
 #start from 1991
 season_mediter_mtc=season_mediter_mtc[season_mediter_mtc$index %in% c(1991:2018),]
 season_red_mtc=season_red_mtc[season_red_mtc$index %in% c(1991:2018),]
 #season_mediter_mtc=rename(season_mediter_mtc,replace =  c("index"="Year"))
 season_mediter_mtc=rename(season_mediter_mtc,Year=index)
 #season_red_mtc=rename(season_red_mtc,replace =  c("index"="Year"))
 season_red_mtc=rename(season_red_mtc,Year=index)
 
 #bind mean net temperature and mean depth - NA in the missing values 
 season_mediter_mtc=full_join(season_mediter_mtc,season_temp_depth,by=c("Year","Season"))
 season_red_mtc=full_join(season_red_mtc,season_temp_depth,by=c("Year","Season"))
 

 
```


#---MTC by Year - season graphs  [8 graphs]
```{r}

formula <- y ~ poly(x, 2, raw = TRUE)
formula_l = y~x

#mediterranian graph
#winter
p1 = ggplot(season_mediter_mtc[season_mediter_mtc$Season=="winter",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+20.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(18,23, by =0.5),sec.axis = sec_axis(~.-20.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Winter")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+20.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
#geom_text(data =season_mediter_mtc[season_mediter_mtc$Year =="2004", ], aes(label = "MTC"), hjust = 1,vjust = 1.5)+#label to lines - cheated
#geom_text(data =season_mediter_mtc[season_mediter_mtc$Year =="1993", ], aes(label = "SST_Anomaly"), hjust = -0.4,vjust = -3,color = "blue")
 #Mediterranian Species MTC By Year, Compare To SST Anomaly
 


#spring
p2 = ggplot(season_mediter_mtc[season_mediter_mtc$Season=="spring",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+20.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(18.5,23, by =0.5),sec.axis = sec_axis(~.-20.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Spring")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+20.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
# Mediterranian Species MTC By Year, Compare To SST Anomaly

#autmn
p3 = ggplot(season_mediter_mtc[season_mediter_mtc$Season=="autumn",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+21.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(18,24.5, by =0.5),sec.axis = sec_axis(~.-21.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Autumn")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+21.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
 #Mediterranian Species MTC By Year, Compare To SST Anomaly
 

#summer
p4 = ggplot(season_mediter_mtc[season_mediter_mtc$Season=="summer",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
 scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+20.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(18,23, by =0.5),sec.axis = sec_axis(~.-20.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Summer")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+20.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
# Mediterranian Species MTC By Year, Compare To SST Anomaly


grid.arrange(p1,p2,p3,p4, ncol = 2)






#red sea graph
#winter
p1 = ggplot(season_red_mtc[season_red_mtc$Season=="winter",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+25.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(23,28, by =0.5), limits = c(23,28),sec.axis = sec_axis(~.-25.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Winter")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+25.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
# Red Sea Species MTC By Year, Compare To SST Anomaly



#spring
p2 = ggplot(season_red_mtc[season_red_mtc$Season=="spring",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+25, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(23,27.5, by =0.5), limits = c(23,27.5),sec.axis = sec_axis(~.-25, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Spring")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+25), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
# Red Sea Species MTC By Year, Compare To SST Anomaly


#summer
p3 = ggplot(season_red_mtc[season_red_mtc$Season=="summer",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+25.5, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(23,28, by =0.5), limits = c(23,28),sec.axis = sec_axis(~.-25.5, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Summer")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+25.5), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
# Red Sea Species MTC By Year, Compare To SST Anomaly


#autmn
p4 = ggplot(season_red_mtc[season_red_mtc$Season=="autumn",], aes(x=Year ,y=mtc,colour=Depth, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2),limits = c(1991,2018))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = FALSE, option = "D") +#color of the graph
  #geom_line(aes(y = SST_anom+26, colour = SST_anom,size = 1))+#pot SST in the MTC scale
  scale_y_continuous(breaks=seq(24.5,27.5, by =0.5), limits = c(24.5,27.5),sec.axis = sec_axis(~.-26, name = "SST Anomaly"))+#create second axes to SST
  ggtitle("Autumn")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5, color = "green",linetype = "twodash") +
  stat_smooth(aes(y =  SST_anom+26), #smooth to SST
              method = "lm", formula = formula_l, se = FALSE, size = 1, color = "red")
 #Red Sea Species MTC By Year, Compare To SST Anomaly


grid.arrange(p1,p2,p3,p4, ncol = 2)

```







#----net mtc----
```{r}
 #drop the useless data for the mtc function
  species_code=rownames(mean_tcode)
  net_all_data=dplyr:: select(all_data,X,species_code)

  #calling mtc function
  net_mtc=mtc_index_calc(net_all_data,mean_tcode)
  net_all_data=cbind(all_data,"mtc"=net_mtc$mtc)
  
  write.csv(net_all_data,"prosseced data/net_mtc_data.CSV")
  
 # plot(net_all_data$Year,net_all_data$mtc)
  
 
 # ggplot(net_all_data, aes(x=Year,y=mtc,colour=depth_meter))+
 #   geom_point()+
 #   ggtitle("NET'S MTC by Year")+xlab("Year")  

 #--- net mtc by origin---
  #mediter mtc
  #drop the useless data for the mtc function
      net_mediter_data=dplyr:: select(mediter_all_data,X,mediter_code)

  #calling mtc function
    net_mediter_mtc=mtc_index_calc(net_mediter_data,mediter_mean_tcode)
      net_mediter_data=cbind(mediter_all_data,"mtc"=net_mediter_mtc$mtc)
  
    write.csv(net_mediter_data,"prosseced data/mediter_net_mtc.CSV")
    
    #red mtc
  #drop the useless data for the mtc function
      net_red_data=dplyr:: select(red_all_data,X,red_code)

  #calling mtc function
    net_red_mtc=mtc_index_calc(net_red_data,red_mean_tcode)
      net_red_data=cbind(red_all_data,"mtc"=net_red_mtc$mtc)
  
    write.csv(net_red_data,"prosseced data/red_net_mtc.CSV")

```






#--mtc by SST graphs


```{r}
net_mediter_data = read.csv("prosseced data/mediter_net_mtc.CSV")
  net_red_data = read.csv("prosseced data/red_net_mtc.CSV")

#get out rows without mtc, SST, and depth deepre than 100 m
  net_mediter_data = net_mediter_data %>%  dplyr:: filter(!is.na(mtc)) %>%
      filter(Depth< 100) %>%  dplyr:: filter(!is.na(SST))
  
net_red_data = net_red_data %>%  dplyr:: filter(!is.na(mtc)) %>% 
      filter(Depth< 100)%>%  dplyr:: filter(!is.na(SST))
  
#create data with mean and anomaly of yearly SST and mtc
  anom_med =net_mediter_data %>% dplyr::select(Year, SST, mtc) %>% filter(Year > 1990) %>% 
    group_by(Year) %>% summarise_all(.funs=mean) %>%
      dplyr::mutate("SST_anom" = SST - mean(SST)) %>%   dplyr::mutate("mtc_anom" = mtc - mean(mtc))

  anom_red =net_red_data %>% dplyr::select(Year, SST, mtc) %>% filter(Year > 2000) %>% 
    group_by(Year) %>% summarise_all(.funs=mean) %>%
      dplyr::mutate("SST_anom" = SST - mean(SST)) %>%   dplyr::mutate("mtc_anom" = mtc - mean(mtc))


   

#Corolation of SST by MTc -  mean yearly values,

ggplot(anom_med, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(anom_red, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red") 



#Corolation of SST by MTc -  mean yearly anomaly values,

ggplot(anom_med, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(anom_red, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red") 


```




#----------GAM model ----------------------------#

#---gam and AIC functions
1. GAM_models_mtc_sum: create list of gam models, with and without interactions

input:
  1. data_in = the data to make gam on, whith the columns:
  Year, Month, Depth,Fisherman,Start_hh
  2. y_par - y axis paramater - mtc, Sum or species name, as character
  
  
  output:
  gam list with 4 gam models:
    1.simp - by Year, Depth and Month
    2.co - with Fisherman and hour of start also
    3.simp_int - as 1 with interactions
    4. co_int - as 2 with interactions
    

2. AIC_GAM_F - create table of AIC for the model get inside
  
  input:
    gam list, the output of gam function
    
  output:
    table with models names and AIC values, from smallest to largest, with delta column
 
 
3. GAMM_auto_mtc_sum
create list of gamm models, with and without autocorrelation

input:
  1. data_in = the data to make gamm on, whith the columns:
  Year, Month, Depth,Fisherman,Start_hh, DateTime
  
  2. y_par - y axis paramater - mtc, Sum or species name, as character
 
 output:
  gamm list with 8 gam models: simp and co are withouth autocorrelation, and all the others are with autocorrelation of Net_number by month - autocorrealtion within any month. the number is about p. (simp_1 -> p=1)
  simp - by Year, Depth and Month
  simp_1
  simp_3
  co - with Fisherman and hour of start also
  co_1
  co_3
  co_5

   
    
4. AIC_GAM_auto - create table of AIC for the autocorelation model get inside
  
  input:
    gamm list, the output of gamm function, 
    
  output:
    table with models names and AIC values



5. dev_ex_fun - put deviance explained of bam/gam modells to the AIC table

  input: 
    bam list, the output of bam function
    aic dataframe, the output of AIC function
    
  output: 
    AIC table with column of deviance explain

```{r}
#1
GAM_models_mtc_sum=function(data_in,y_par){
  
  temp = data_in
  temp = temp %>% dplyr::select(y_par,Year, Month, Depth,Fisherman,Start_hh )
  temp = as.data.frame(temp)
  
  
    #simple model - by Year Depth and Month
    simp <- gam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12), data = temp)
  
  print(simp)
  
  co <- gam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
  
  print(co)
  
  simp_int = gam(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth), data = temp)
  
  print(simp_int)
  
  co_int = gam(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)

  print(co_int)
  
  #create list of model outputs
  gam_list=list(simp, co, simp_int, co_int)
  
  names(gam_list)=c("simp","co","simp_int","co_int")
  
  return(gam_list)
  }#end GAM_models_list function

#2
AIC_GAM_F=function(gam_fun_out){
#Ittay part... just took it as is
    AIC_df=data.frame(model_name=names(gam_fun_out))
  AIC_v=c()
  for(i in 1:length(gam_fun_out)){
  AIC_df_n=AIC(gam_fun_out[[i]])
  AIC_v=c(AIC_v,AIC_df_n)
  }
  AIC_df$AIC=AIC_v
  
  #arrange and write the delta values
  AIC_df = AIC_df %>% arrange(AIC) %>% 
  mutate(delta = AIC - first(AIC))
  
  return(AIC_df)
}



#3
GAMM_auto_mtc_sum=function(net_data,y_par){
  
  #create Net_number and YearMonth columns for the autocorrelation
  temp = net_data
  temp = temp %>% dplyr::select(y_par,Year, Month, Depth,Fisherman,Start_hh, DateTime )
  temp = as.data.frame(temp)
  # temp = temp %>% arrange(DateTime) %>% mutate(Net_num = c(1:nrow(temp))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))
  # temp$YearMonth = as.Date(as.yearmon(temp$YearMonth,"%Y/%m"))
  
    simp <- gamm(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12), data = temp)
  
    summary(simp$gam)
    
  simp_3 <- gamm(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = temp)
  
  summary(simp_3$gam)
  
    simp_int = gamm(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = temp)
  
    summary(simp_int$gam)
  
   co <- gamm(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
  
   summary(co$gam)
   
   
  co_3 <- gamm(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = temp)
  
  summary(co_3$gam)
  
  co_int = gamm(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = temp)
  
summary(co_int$gam)
  
  
  #create list of model outputs
  gamm_list=list(simp, simp_3, simp_int, co, co_3, co_int)
  
  names(gamm_list)=c("simp", "simp_3", "simp_int", "co", "co_3", "co_int")
  
  return(gamm_list)
  }#end GAMm_auto_list function



bam_mtc_sum=function(net_data,y_par){
  
  #create Net_number and YearMonth columns for the autocorrelation
  temp = net_data
  temp = temp %>% dplyr::select(y_par,Year, Month, Depth,Fisherman,Start_hh)
  temp = as.data.frame(temp)
  # temp = temp %>% arrange(DateTime) %>% mutate(Net_num = c(1:nrow(temp))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))
  # temp$YearMonth = as.Date(as.yearmon(temp$YearMonth,"%Y/%m"))
  
  
  co <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
 print("co")
  
  co_1 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = temp)
  
  print("co_1") 
   
  co_3 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = temp)
  
  print("co_3")
  
  co_5 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.5, data = temp)
  
  print("co_5")
 
  co_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)   + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
 print("co_int")
  
  co_1_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = temp)
  
  print("co_1_int") 
   
  co_3_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12) + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = temp)
  
  print("co_3_int")
  
  co_5_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.5, data = temp)
  
  print("co_5_int")
  
  
  #create list of model outputs
  bam_list=list(co, co_1, co_3, co_5,co_int, co_1_int, co_3_int, co_5_int )
  
  names(bam_list)=c("co" ,"co_1", "co_3", "co_5","co_int" ,"co_1_int", "co_3_int", "co_5_int" )
  
    
  return(bam_list)
  }#end bam_auto_list function



#4
AIC_GAM_auto=function(gam_fun_out){
  AIC_df=data.frame(model_name=names(gam_fun_out))
  AIC_v=c()
  for(i in 1:length(gam_fun_out)){
  AIC_df_n=AIC(gam_fun_out[[i]]$lme)
  AIC_v=c(AIC_v,AIC_df_n)
  }
  AIC_df$AIC=AIC_v
  
  AIC_df = AIC_df %>% arrange(AIC) %>% 
  mutate(delta = AIC - first(AIC))
  
  return(AIC_df)
}



#5
dev_ex_fun = function(aic_dataframe,bam_list_in){
  #--cerate deviece explain dataframe
  #deviance of each model
 
  dev_v = c()
  for (i in 1:length(bam_list_in)) {
    
    dev_temp = 1-bam_list_in[[i]]$deviance/bam_list_in[[i]]$null.deviance
    dev_temp = dev_temp*100
    dev_v[i] = dev_temp
    
  }

  dev_ex = data.frame(model_name = names(bam_list_in))
  dev_ex$Deviance_explained =dev_v
  
  #joind deviance explain to AIC data frame
 aic_dataframe =  left_join(aic_dataframe, dev_ex)
  
  return(aic_dataframe)
}
  


#6
bam_season_mtc_sum=function(net_data,y_par){
  
  #create Net_number and YearMonth columns for the autocorrelation
  temp = net_data
  temp = temp %>% dplyr::select(y_par,Year, Month, Depth,Fisherman,Start_hh)
  temp = as.data.frame(temp)
  
  
  co <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
 print("co")
  
  co_1 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = temp)
  
  print("co_1") 
   
  co_3 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = temp)
  
  print("co_3")
  
  co_5 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.5, data = temp)
  
  print("co_5")
 
  year <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc"), data = temp)
 print("year")
  
  year_1 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = temp)
  print("year_1") 
   
  year_3 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = temp)
  
  print("year_3")
  
  year_5 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.5, data = temp)
  
  print("year_5")
  
  
  #create list of model outputs
  bam_list=list(co, co_1, co_3, co_5,year, year_1, year_3, year_5 )
  
  names(bam_list)=c("co" ,"co_1", "co_3", "co_5","year" ,"year_1", "year_3", "year_5" )
  
    
  return(bam_list)
  }#end bam_auto_list function



```



#uploud data and edit
```{r}
#----the whole data GAm model---
net_all_data = read.csv("prosseced data/net_mtc_data.CSV")


#get out rows without mtc, and depth deeper then 100 m or less than 20
net_all_data = net_all_data %>% filter(Year > 1990) %>% dplyr::select(-Depth) %>%
   rename(Depth = depth_meter) %>%  dplyr:: filter(!is.na(mtc))  %>% dplyr::filter(Depth<100)%>% replace_na(list(Gambari_net = FALSE)) %>% filter(Gambari_net==FALSE) %>% mutate(Date_num = as.numeric(Date))  %>% arrange(DateTime) 
net_all_data = net_all_data %>% mutate(Net_num = c(1:nrow(net_all_data))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))
net_all_data$YearMonth = as.Date(as.yearmon(net_all_data$YearMonth,"%Y/%m"))

#---seperate by origin---

#upload mediter and red sea data.
net_mediter_mtc = read.csv("prosseced data/mediter_net_mtc.CSV")
net_red_mtc = read.csv("prosseced data/red_net_mtc.CSV")

#get out rows without mtc and depth deepre than 100 m 
 # start the  in 1991 [year],no gamberi net,, put date_num column

 net_red_mtc = net_red_mtc %>% filter(Year > 1990)  %>% dplyr::select(-Depth) %>% rename(Depth = depth_meter) %>%  dplyr:: filter(!is.na(mtc)) %>% dplyr::filter(Depth<100)%>% replace_na(list(Gambari_net = FALSE)) %>% filter(Gambari_net==FALSE) %>% mutate(Date_num = as.numeric(Date))  %>% arrange(DateTime)
 net_red_mtc = net_red_mtc %>% mutate(Net_num = c(1:nrow(net_red_mtc))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))
 net_red_mtc$YearMonth = as.Date(as.yearmon(net_red_mtc$YearMonth,"%Y/%m"))
 
 net_mediter_mtc = net_mediter_mtc %>% filter(Year > 1990)%>% dplyr::select(-Depth) %>%
   rename(Depth = depth_meter) %>%  dplyr:: filter(!is.na(mtc))  %>% dplyr::filter(Depth<100)%>% replace_na(list(Gambari_net = FALSE)) %>% filter(Gambari_net==FALSE) %>% mutate(Date_num = as.numeric(Date))  %>% arrange(DateTime) 
 net_mediter_mtc = net_mediter_mtc%>% mutate(Net_num = c(1:nrow(net_mediter_mtc))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))

 net_mediter_mtc$YearMonth = as.Date(as.yearmon(net_mediter_mtc$YearMonth,"%Y/%m"))
 
 
```


#---- MTC by SST correlation  - graphs for the 4 season together, and separete [10 graphs]--
```{r}


  #4 season together
#Mediterranian
ggplot(net_mediter_mtc, aes(x=SST ,y=mtc,colour=Season, size=3))+
  #geom_point(size = 0.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
 # ggtitle("Mediter")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 


#red Sea
ggplot(net_red_mtc, aes(x=SST ,y=mtc,colour=Season, size=3))+
  #geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
 scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(23,28, by =0.25))+
 # ggtitle("Red Sea")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5)
  
#pearson correlation: 
sp <- ggscatter(net_mediter_mtc[net_mediter_mtc$Season=="winter",], x = "SST", y = "mtc",palette = "jco",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
# Add correlation coefficient
sp+ stat_cor(method = "pearson", label.x = 3, label.y = 30)
  #scale_x_continuous (breaks=seq(15,30, by = 2), limits = c(15,25))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =1), limits = c(16,28)) 


sp <- ggscatter(net_mediter_mtc[net_mediter_mtc$Season=="summer",], x = "SST", y = "mtc",palette = "jco",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
# Add correlation coefficient
sp+ stat_cor(method = "pearson", label.x = 3, label.y = 30)


#for any season separatly
ggplot(net_mediter_mtc[net_mediter_mtc$Season=="winter",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
  ggtitle("Mediter - winter")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_mediter_mtc[net_mediter_mtc$Season=="spring",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
 ggtitle("Mediter - spring")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_mediter_mtc[net_mediter_mtc$Season=="autumn",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
 ggtitle("Mediter - autumn")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_mediter_mtc[net_mediter_mtc$Season=="summer",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
  ggtitle("Mediter - summer")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 


#red sea
ggplot(net_red_mtc[net_red_mtc$Season=="winter",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
  ggtitle("red - winter")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_red_mtc[net_red_mtc$Season=="spring",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
 ggtitle("red - spring")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_red_mtc[net_red_mtc$Season=="autumn",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
 ggtitle("red - autumn")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 

ggplot(net_red_mtc[net_red_mtc$Season=="summer",], aes(x=SST ,y=mtc, size=3 ))+
  geom_point(color = "green", size = 1.5)+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(15,30, by = 2))+ #x axis years apeared
scale_color_viridis(begin = 0, end = 0.8 ,direction = -1,discrete = TRUE, option = "D") +#color of the graph
  scale_y_continuous(breaks=seq(16,28, by =0.5))+
  ggtitle("red - summer")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = FALSE, size = 1.5) 


```


#call to gam function and AIC on mtc gams

```{r}
#compare between seasonality bam models to models without "month"
#bam function, AIC and deviance explain functions:
red_season_mtc_bam = bam_season_mtc_sum(net_red_mtc,"mtc")
aic_red_season_mtc = AIC_GAM_F(red_season_mtc_bam)
aic_red_season_mtc = dev_ex_fun(aic_red_season_mtc,red_season_mtc_bam)

med_season_mtc_bam = bam_season_mtc_sum(net_mediter_mtc,"mtc")
aic_med_season_mtc = AIC_GAM_F(med_season_mtc_bam)
aic_med_season_mtc = dev_ex_fun(aic_med_season_mtc,med_season_mtc_bam)

all_season_mtc_bam = bam_season_mtc_sum(net_all_data,"mtc")
aic_all_season_mtc = AIC_GAM_F(all_season_mtc_bam)
aic_all_season_mtc = dev_ex_fun(aic_all_season_mtc,all_season_mtc_bam)

row.names(aic_red_season_mtc) = c("red","2","3","4","5","6","7","8")
row.names(aic_all_season_mtc) = c("all","2","3","4","5","6","7","8")
row.names(aic_med_season_mtc) = c("med","2","3","4","5","6","7","8")

aic_season_mtc = rbind(aic_all_season_mtc, aic_med_season_mtc, aic_red_season_mtc)
write.csv(aic_season_mtc,"prosseced data/aic_season_mtc_bam.CSV")

#call the function on mtc red sea gams
#red_mtc_gam = GAM_models_mtc_sum(net_red_mtc,"mtc")
#aic_red_mtc = AIC_GAM_F(red_mtc_gam)

red_mtc_bam = bam_mtc_sum(net_red_mtc,"mtc")
aic_red_mtc = AIC_GAM_F(red_mtc_bam)
aic_red_mtc = dev_ex_fun(aic_red_mtc,red_mtc_bam)

 par(mfrow = c(2,2))
  plot(  red_mtc_gam[[4]],se=TRUE,col = "blue") 
 

#med_mtc_gam = GAM_models_mtc_sum(net_mediter_mtc,"mtc")
#aic_med_mtc = AIC_GAM_F(med_mtc_gam)

med_mtc_bam = bam_mtc_sum(net_mediter_mtc,"mtc")
aic_med_mtc = AIC_GAM_F(med_mtc_bam)
aic_med_mtc = dev_ex_fun(aic_med_mtc,med_mtc_bam)

 par(mfrow = c(2,2))
  plot(  med_mtc_gam[[4]],se=TRUE,col = "blue") 

#all_mtc_gam = GAM_models_mtc_sum(net_all_data,"mtc")
#aic_all_mtc = AIC_GAM_F(all_mtc_gam)

all_mtc_bam = bam_mtc_sum(net_all_data,"mtc")
aic_all_mtc = AIC_GAM_F(all_mtc_bam)
aic_all_mtc = dev_ex_fun(aic_all_mtc, all_mtc_bam)

row.names(aic_red_mtc) = c("red","2","3","4","5","6","7","8")
row.names(aic_all_mtc) = c("all","2","3","4","5","6","7","8")
row.names(aic_med_mtc) = c("med","2","3","4","5","6","7","8")

aic_mtc = rbind(aic_all_mtc, aic_med_mtc, aic_red_mtc)
write.csv(aic_mtc,"prosseced data/aic_mtc_bam.CSV")



```
  
  for the autocorelation function
  
  m_t_AR1 <- gamm(sp_dens ~ s(depth_meter) + s(Month, bs = "cc", k = 10) + s(Time),
                    correlation = corARMA(form = ~ 1|year_mont, p = 1),
                    data = data_in_sp,family=Tweedie(2),knots = list(Month = c(0.5, 12.5)),niterPQL=100)
 
  #p=3
  
    m_t_AR3 <- gamm(sp_dens ~ s(depth_meter) + s(Month, bs = "cc", k = 10) + s(Time), correlation = corARMA(form = ~ 1|year_mont, p = 3),data = data_in_sp,family=Tweedie(2),knots = list(Month = c(0.5, 12.5)),niterPQL=100)
 
  #p=5
  
    m_t_AR5 <- gamm(sp_dens ~ s(depth_meter) + s(Month, bs = "cc", k = 10) + s(Time), correlation = corARMA(form = ~ 1|year_mont, p = 5),data = data_in_sp,family=Tweedie(2),knots = list(Month = c(0.5, 12.5)),niterPQL=100)
 



#--- mtc gam models and plots

```{r}

 #all data gam model
#gam_all = gamm(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+ s(Start_hh, bs = "cc")+s(Depth)+ (Fisherman),correlation=corARMA(form = ~Net_num|YearMonth,p=1), data = net_all_data)

#gam_all = gamm(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                             #s(Month, bs = "cc", k=12),correlation=corARMA(form = ~Net_num|YearMonth,p=1),data #=net_all_data)

 gam_all <- bam(mtc ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12) + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = net_all_data)
#
#gam_all = gam(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                           #  s(Month, bs = "cc", k=12),data =net_all_data)
#+ (Fisherman)+ s(Start_hh, bs = "cc")+s(Date_num, bs = "gp")

summary(gam_all$gam)
    par(mfrow = c(2,2))
      gam.check(gam_all)

#plot(gam_year,select = 2,shade = TRUE):plot(fitted(gam_year),residuals(gam_year))

par(mfrow = c(2,2)) 
plot(gam_all,se=TRUE,col = "blue")


#mediter_gam_month = gamm(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = net_mediter_mtc)

mediter_gam_month <- bam(mtc ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12) + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = net_mediter_mtc)

 # mediter_gam_month = gam(mtc ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc")   +s(Month, bs = "cc", k=12),data =net_mediter_mtc)
  
  # + (Fisherman)+ s(Start_hh, bs = "cc")  +   s(Date_num, bs = "gp")  
                        
  
  summary(mediter_gam_month$gam)
    par(mfrow = c(2,2))
      gam.check(mediter_gam_month$gam)
  
par(mfrow = c(2,2)) 
plot(mediter_gam_month,se=TRUE,col = "blue")
   # net_red_mtc = net_red_mtc %>% filter(Year>1999)

#red_gam_month = gamm(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = net_red_mtc)
  

red_gam_month <- bam(mtc ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12) + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.3, data = net_red_mtc)

 # red_gam_month = gam(mtc ~ s(Year, bs = "cr") + s(Depth) + (Fisherman)+ s(Start_hh, bs = "cc")   +s(Month, bs = "cc", k=12) ,data = net_red_mtc,method = "REML")

  
  #autocorrelation model
    #red_gam_month =  gamm(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth), correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = temp) 
#(Fisherman)+ s(Start_hh, bs = "cc")+s(Date_num, bs = "gp")  + 
  
  summary(red_gam_month$gam)
    par(mfrow = c(2,2))
      gam.check(red_gam_month$gam)
      
      par(mfrow = c(2,3)) 
plot(red_gam_month,se=TRUE,col = "blue")
  
  #---------------nice graphs for thesis-------------
  gam_all = getViz(gam_all)
mediter_gam_month <- getViz(mediter_gam_month)
red_gam_month = getViz(red_gam_month)
#red_gam_month = getViz(red_gam_month$gam)



p_red_mtc = plot( sm(red_gam_month, 1) )+ l_ciPoly(level = 0.95,fill = "grey")+l_fitLine(colour = "red")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 1))+labs(y ="Relative MTC")+scale_x_continuous (breaks=seq(1991,2018, by = 2))  +ggtitle("Alien species")
#dev.copy(png,'p_red_mtc.png', width = 1600, height = 1200)
#save the graph
dev.copy(png,'p_red_mtc.png')
 dev.off()

p_all_mtc = plot( sm(gam_all, 1) )+ l_ciPoly(level = 0.95,fill = "grey")+l_fitLine(colour = "purple")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 3))+labs(y ="Relative MTC")+scale_x_continuous (breaks=seq(1991,2018, by = 2)) +ggtitle("Whole known origin species")
#save the graph
dev.copy(png,'p_all_mtc.png')
 dev.off()



  plot( sm(mediter_gam_month, 1) )+ l_ciPoly(level = 0.95,fill = "grey")+l_fitLine(colour = "blue")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 3))+labs(y ="Relative MTC")+scale_x_continuous (breaks=seq(1991,2018, by = 2)) +ggtitle("Indigenous species")
#save the graph
  dev.copy(png,'p_med_mtc.png')
 dev.off()




plot( sm(mediter_gam_month, 2) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -2),axis.title.y = element_text(vjust = 3))+labs(y ="Temperature affinity",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,100)) 

plot( sm(mediter_gam_month, 3) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -2),axis.title.y = element_text(vjust = 3))+labs(y ="Temperature affinity")+scale_x_continuous (breaks=seq(1,12, by = 1)) 



plot( sm(red_gam_month, 2) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -2),axis.title.y = element_text(vjust = 3))+labs(y ="Temperature affinity",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,90)) 

plot( sm(red_gam_month, 3) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -2),axis.title.y = element_text(vjust = 3))+labs(y ="Temperature affinity")+scale_x_continuous (breaks=seq(1,12, by = 1)) 


  
  



```

#--autocorolation on gamm model

```{r}
#sort by date and time and create "Net_num" - number of net after filtering, represent the net order

net_red_mtc = net_red_mtc %>% arrange(DateTime) %>% mutate(Net_num = c(1:nrow(net_red_mtc)))

net_red_mtc = net_red_mtc %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))

net_red_mtc$YearMonth = as.Date(as.yearmon(net_red_mtc$YearMonth,"%Y/%m"))


#gamm with autocorrolation within day - ARM1
gamm_red = gamm(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                             s(Month, bs = "cc", k=12),correlation=corAR1(form = ~Net_num|Date_num), data =net_red_mtc)


plot(gamm_red$gam,se=TRUE,col = "blue")
title("mtc red sea gam - autocorrolation within day")


#gamm with autocorrolation within month - ARM1
gamm_red = gamm(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                             s(Month, bs = "cc", k=12),correlation=corAR1(form = ~Net_num|YearMonth), data =net_red_mtc)


summary(gamm_red$gam)
    par(mfrow = c(2,2))
      gam.check(gamm_red)

      
par(mfrow = c(2,2)) 
plot(gamm_red$gam,se=TRUE,col = "blue")
title("mtc red sea gam - autocorrolation within month")


#gamm with autocorrolation within day - ARMA
gamm_red = gamm(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                             s(Month, bs = "cc", k=12),correlation=corARMA(form = ~Net_num|Date_num,p=3), data =net_red_mtc)


plot(gamm_red$gam,se=TRUE,col = "blue")
title("mtc red sea gam - autocorrolation within day")

#gamm with autocorrolation within day - ARMA
gamm_red = gamm(mtc ~ s(Year, bs = "cr")+ (Fisherman)+ s(Start_hh, bs = "cc") + s(Depth)   + 
                             s(Month, bs = "cc", k=12),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data =net_red_mtc)


plot(gamm_red$gam,se=TRUE,col = "blue")
title("mtc red sea gam - autocorrolation within MOnt")


```


#-------interactions MTC GAM models-------

```{r}

# The data is from the "upload data" chunk, just above

#whole konon origin species togother
temp = net_all_data %>% dplyr::select(Year, Month, Depth, mtc, Fisherman, Start_hh  ) 
  
temp = as.data.frame(temp)
  
  # temp_gam = gam(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp)
  
#to take the gam model I choose above
   temp_gam = gam_all
 
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
  par(mfrow(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Whole known origin species",
         x = NULL,
         y = "MTC") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=25))
    
    p1
    
    ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/mtc/all_int.png", p1, dpi = 200)
  



#Medeterranean species interaction model
temp = net_mediter_mtc %>% dplyr::select(Year, Month, Depth, mtc, Fisherman, Start_hh ) 
  
temp = as.data.frame(temp)
  
 #  temp_gam = gam(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp)
  
#to take the gam model I choose above 
    temp_gam = mediter_gam_month
  
#temp_gam = gamm(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth),correlation=corARMA(form = ~Net_num|YearMonth,p=3), data = net_mediter_mtc)
   #+ (Fisherman)+ s(Start_hh, bs = "cc")
    
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
   par(mfrow=c(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")
  plot(  temp_bam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
 
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function


## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))


## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Indigenous species",
         x = NULL,
         y = "MTC") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=25))
    
    
    p1

  ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/mtc/med_int.png", p1, dpi = 200)




#red sea interaction
temp = net_red_mtc %>% dplyr::select(Year, Month, Depth, mtc, Fisherman, Start_hh )
temp = as.data.frame(temp)
  
   #temp_gam = gam(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp)
   
   #to take the gam model I choose above
   temp_gam = red_gam_month
   
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
  par(mfrow(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Alien species",
         x = NULL,
         y = "MTC") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=25))
    
    p1

 ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/mtc/red_int.png", p1, dpi = 200)
  




```




#----biomass model - sum of catch and by month, yaer and depth for Med and Red. all is in phnology part-------
```{r}
#create Sum columns - sum of the catch of any net

tempor_sum = net_mediter_mtc %>% dplyr::select(Aal:WHT) 
 catch_net_sum = rowSums(tempor_sum)
 net_mediter_mtc = net_mediter_mtc %>% dplyr::mutate(Sum = cbind(catch_net_sum))
 
 tempor_sum = net_red_mtc %>% dplyr::select(Nra:Upo) 
 catch_net_sum = rowSums(tempor_sum)
 net_red_mtc = net_red_mtc %>% dplyr::mutate(Sum = cbind(catch_net_sum)) 
 
  #the chatch of 2018 is problematic - half a year, effecting the model
net_mediter_mtc = net_mediter_mtc %>% filter(Year<2018)
 net_red_mtc = net_red_mtc %>% filter(Year<2018)%>% filter(Year>1999)
 #
 

 
 
  #------call the function on Sum  gams and bam
#compare between seasonality bam models to models without "month"
#bam function, AIC and deviance explain functions:
red_season_sum_bam = bam_season_mtc_sum(net_red_mtc,"Sum")
aic_red_season_sum = AIC_GAM_F(red_season_sum_bam)
aic_red_season_sum = dev_ex_fun(aic_red_season_sum,red_season_sum_bam)

med_season_sum_bam = bam_season_mtc_sum(net_mediter_mtc,"Sum")
aic_med_season_sum = AIC_GAM_F(med_season_sum_bam)
aic_med_season_sum = dev_ex_fun(aic_med_season_sum,med_season_sum_bam)

row.names(aic_red_season_sum) = c("red","2","3","4","5","6","7","8")
row.names(aic_med_season_sum) = c("med","2","3","4","5","6","7","8")

aic_season_sum = rbind(aic_med_season_sum, aic_red_season_sum)

 
 
#red_catch_gam = GAM_models_mtc_sum(net_red_mtc,"Sum")
#aic_red_catch = AIC_GAM_F(red_catch_gam)

red_catch_bam = bam_mtc_sum(net_red_mtc,"Sum")
aic_red_catch = AIC_GAM_F(red_catch_bam)
aic_red_catch = dev_ex_fun(aic_red_catch,red_catch_bam)


 par(mfrow = c(2,2))
  plot(  red_catch_bam[[4]],se=TRUE,col = "blue") 
 

#med_catch_gam = GAM_models_mtc_sum(net_mediter_mtc,"Sum")
#aic_med_catch = AIC_GAM_F(med_catch_gam)

med_catch_bam = bam_mtc_sum(net_mediter_mtc,"Sum")
aic_med_catch = AIC_GAM_F(med_catch_bam)
aic_med_catch = dev_ex_fun(aic_med_catch,med_catch_bam)

 par(mfrow = c(2,2))
  plot(  med_catch_gam[[1]],se=TRUE,col = "blue") 

 row.names(aic_red_catch) = c("red","2","3","4","5","6", "7", "8")
row.names(aic_med_catch) = c("med","2","3","4","5","6", "7", "8") 

aic_catch = rbind(aic_red_catch,aic_med_catch)
  
  
  

mediter_catch_gam <- bam(Sum ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = net_mediter_mtc)


  summary(mediter_catch_gam$gam)
  gam.check(mediter_catch_gam$gam)
  
  
  par(mfrow = c(2,2)) 
  plot(  mediter_catch_gam$gam,se=TRUE,col = "blue")
    title("Mediteranean species catch by month And year",line = -2, outer=TRUE)

  
#red sea    
      red_catch_gam <- bam(Sum ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.5, data = net_red_mtc)
    
     summary(red_catch_gam$gam)
     par(mfrow = c(2,2)) 
  gam.check(red_catch_gam$gam)
  
  par(mfrow = c(2,2)) 
  plot(  red_catch_gam$gam,se=TRUE,col = "blue")
  title("Red species catch by month and year",line = -2, outer=TRUE)
  
#nice plots  
mediter_catch_gam <- getViz(mediter_catch_gam)
red_catch_gam = getViz(red_catch_gam)

 
p_med_catch = plot( sm(mediter_catch_gam, 1) )+ l_ciPoly(level = 0.95,fill = "grey")+l_fitLine(colour = "blue")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 1))+labs(y ="Relative catch biomass")+scale_x_continuous (breaks=seq(1991,2018, by = 2)) +ggtitle("Indigenous species")
dev.copy(png,'p_med_catch.png')
 dev.off()

p_red_catch = plot( sm(red_catch_gam, 1) )+ l_ciPoly(level = 0.95,fill = "grey")+l_fitLine(colour = "red")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 1))+labs(y ="Relative catch biomass")+scale_x_continuous (breaks=seq(1991,2018, by = 2)) +ggtitle("Alien species")
dev.copy(png,'p_red_catch.png')
 dev.off()


```

#-----biomass model - interaction medels and graphs-----
```{r}


# catch interaction model and graph


#mediter interaction model
 temp = net_mediter_mtc %>% dplyr::select(Year, Month, Depth, Sum, Fisherman, Start_hh ) 
  
temp = as.data.frame(temp)
  
  # temp_gam = gam(Sum ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp )
  
#take the model I choos above
temp_gam = mediter_catch_gam
 
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
  par(mfrow(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Indigenous species",
         x = NULL,
         y = "Catch biomass per net [kg]") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
    theme_update(text = element_text(size=20))
    p1

grid.arrange(p1)
  
ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/biomass/med_int.png", p1, dpi = 200)



#red sea interaction
temp = net_red_mtc %>% dplyr::select(Year, Month, Depth, Sum, Fisherman, Start_hh ) 
  
temp = as.data.frame(temp)
  
#   temp_gam = gam(Sum ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp )
 
#take the model I choos above
temp_gam = red_catch_gam 
 
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
  par(mfrow(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Alien species",
         x = NULL,
         y = "Catch biomass per net [kg]") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
    theme_update(text = element_text(size=20))
    
    p1

grid.arrange(p1)
ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/biomass/red_int.png", p1, dpi = 200)
```



#---------------------fenology-----------------------------------------------------------------------------

#uploud the whole fish data
```{r}
#uploud fishes only data. F in the end of names mean "full data", whith species whithout known origin. (difference from the code above)
all_dataF = read.csv(file = "prosseced data/all_data_fishes_only.csv", stringsAsFactors = F)
 scientific_namesF = read.csv(file = "prosseced data/sceintific_names_fishes_only.csv", stringsAsFactors = F)
 
 #remove "box general" boxes, "fish" boxes and "specieal fish boxes".
 scientific_namesF = scientific_namesF %>% dplyr:: filter(Sp_code != "BOX") %>% dplyr::filter(Sp_code != "FIS") %>% dplyr::filter(Sp_code != "SPL")
 
 #cerate DLS column - join Dipoldus species, Marmir species, and boxes with Diplodus and Marmir togother,
 all_dataF = all_dataF %>% mutate(DLS = Lmo+WHT+DIP)
 
 # set NA to FALSE and remove rows with gamberi nets, the columns "fish (FIS)", "general box (BOX)", Speciel fish boxes (SPL), start from 1991, remove depth deeper than 100 m, and stay with 1 depth column, called "Depth"
  all_dataF = all_dataF %>% replace_na(list(Gambari_net=FALSE)) %>% dplyr::filter(Gambari_net=="FALSE") %>% dplyr::select( everything(),-BOX, -FIS, -SPL, -loc_DEPTH, -Depth) %>% filter(Year>1990) %>% rename(Depth = depth_meter) %>% filter(Depth<100) %>% arrange(DateTime) %>% filter(Month>0)
 all_dataF = all_dataF%>% mutate(Net_num = c(1:nrow(all_dataF))) %>% dplyr::mutate(YearMonth = paste(Year, Month, sep = "/"))
  
  
 #cerate species names and code vectors
 sp_codeF=scientific_namesF$Sp_code
 scientific_codeF=scientific_namesF$scintific_name
 
 all_dataF = as_tibble(all_dataF)
 

 
#create sum of catch column
  tempor_sum = all_dataF %>% dplyr::select(Aal:DLS) 
 catch_net_sum = rowSums(tempor_sum)
 all_dataF = all_dataF %>% dplyr::mutate(Sum = cbind(catch_net_sum)) 

  
 
  #----create "catch_ex"- exploration, table with number of nets with data for any species each year

 catch_ex =all_dataF %>% dplyr::select(Year, Aal:DLS) %>% group_by(Year) %>% 
  summarize_all(.fun = function(x) sum(x>0,na.rm = T)) %>% gather(Species, Catch, Aal:DLS, factor_key=TRUE) %>% spread(Year, Catch)
 
#write.csv(catch_ex, file = "prosseced data/sum of nets for species for year.csv")

#table of the species abondance enough for model
catch_sum = read.csv("prosseced data/years for species.csv")
catch_sum = catch_sum[order(catch_sum$Species),]

#vector of the spceis in the model
abondance_species = catch_sum$Species
abondance_species = as.character(abondance_species)
abondance_species = sort(abondance_species)

catch_ab_ex = catch_ex %>% filter(Species %in% abondance_species)

abondance_species_data = scientific_namesF %>% dplyr::select(Sp_code, Sceintific_names = scintific_name) %>% filter(Sp_code %in% abondance_species)

write.csv(abondance_species_data,"prosseced data/abondance species.CSV")
abondance_species_subnames = read.csv("prosseced data/abondance species sub names.CSV")
abondance_species_subnames = abondance_species_subnames %>% dplyr::select(-X)

```


#Fishing efort - interacton graphs of numbert of nets each month each year
```{r}

#create data with Year, Month and "count" - number of nets for each month each year  
net_ex =all_dataF %>% dplyr::select(Year, Month) %>% group_by(Year,Month)%>% summarise(count=n())

simp <-  bam(count ~ s(Year, bs = "cr")+  s(Month, bs = "cc", k=12), data = net_ex)
 
  simp_int <- bam(count ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)   + ti(Month,Year, bs = c("cc","cr")), data = net_ex)

 net_gam_list=list(simp, simp_int )
  
  names(net_gam_list)=c("simp" ,"simp_int" )
  
  aic_net = AIC_GAM_F(net_gam_list)
    
  #--cerate deviece explain dataframe
  #deviance of "simp" model
  dev_ex =  1-simp$deviance/simp$null.deviance
  #deviance of "simp_int" model
  dev_ex_simp_int = 1-simp_int$deviance/simp_int$null.deviance
  #join to 1 data, create simplnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_simp_int)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("simp","simp_int"))
    
  #join deviance explain with aic table
 aic_net =  left_join(aic_net, dev_ex)
 write.csv(aic_catch,"prosseced data/aic_fishing effort.CSV")
  
  
temp_gam = simp_int
par(mfrow = c(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")
  

ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(net_ex, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100)))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Fishing effort", 
         x = NULL,
         y = "Number of nets") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))
    

grid.arrange(p1)

#ggsave("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/fishing effort.png", p1, dpi = 100, width = 8.5, height = 5.5)

ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/fishing effort.png", p1, dpi = 200)
  #, width = 8.5, height = 5.5
  

  
  


```



#--gam model for the whole data catch - regular gam graph, and phenology interaction graph

```{r}
#all_dataF = all_dataF %>% filter(Year<2018)


#compare between seasonality bam models to models without "month"
#bam function, AIC and deviance explain functions:
all_season_sum_bam = bam_season_mtc_sum(all_dataF,"Sum")
aic_all_season_sum = AIC_GAM_F(all_season_sum_bam)
aic_all_season_sum = dev_ex_fun(aic_all_season_sum,all_season_sum_bam)

row.names(aic_all_season_sum) = c("all","2","3","4","5","6","7","8")

aic_season_sum = rbind(aic_season_sum, aic_all_season_sum)
write.csv(aic_catch,"prosseced data/aic_season_catch_bam.CSV")
 


#call to gam and AIC functions
#all_catchF_gam = GAM_models_mtc_sum(all_dataF,"Sum")
#aic_all_catchF = AIC_GAM_F(all_catchF_gam)

all_catchF_bam = bam_mtc_sum(all_dataF,"Sum")
aic_all_catchF = AIC_GAM_F(all_catchF_bam)
aic_all_catchF = dev_ex_fun(aic_all_catchF,all_catchF_bam)


row.names(aic_all_catchF) = c("all","2","3","4","5","6","7","8")
aic_catch = rbind(aic_catch,aic_all_catchF)
write.csv(aic_catch,"prosseced data/aic_catch_bam.CSV")
    
 par(mfrow = c(2,2))
  plot(  all_catchF_bam[[5]],se=TRUE,col = "blue")
  
 
 all_catch_gam <- bam(Sum ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), rho = 0.1, data = all_dataF)

 #all_catch_gam = gam(Sum ~ s(Year, bs = "cr") +s(Month, bs = "cc", k=12)+s(Depth), data = all_dataF )
 summary(all_catch_gam$gam)
  gam.check(all_catch_gam$gam)
  
  par(mfrow = c(2,2)) 
  plot(  all_catch_gam$gam,se=TRUE,col = "blue")
    title("whole fish species catch by month and year",line = -2, outer=TRUE)

    all_catch_gam = getViz(all_catch_gam)

p_all_catch = plot( sm(all_catch_gam, 1) )+ l_ciPoly(level = 0.95 ,fill = "grey")+l_fitLine(colour = "purple")  + theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=0),axis.title.x = element_text(vjust = 0),axis.title.y = element_text(vjust = 1))+labs(y ="Relative catch biomass")+scale_x_continuous (breaks=seq(1991,2018, by = 2)) +ggtitle("Whole fish species")
dev.copy(png,'p_all_catch.png')
 dev.off()


# interaction model and graph
   temp = all_dataF %>% dplyr::select(Year, Month, Depth, Sum, Fisherman, Start_hh ) 
  
temp = as.data.frame(temp)
  
  # temp_gam = gam(Sum ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp )
  
#take the model I choose above
temp_gam = all_catch_gam
 
  summary(temp_gam)
  par(mfrow = c(2,2)) 
  gam.check(temp_gam)
  
  par(mfrow = c(2,2))
  plot(  temp_gam,se=TRUE,col = "blue")  
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"  ))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = "Whole fish species",
         x = NULL,
         y = "Catch biomass per net [kg]") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))
    
    p1
  

grid.arrange(p1)
ggsave("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/biomass/all_int.png", p1, dpi = 200)
  


```


#---Seasonality AIC: loop - GAM models, AIC test comparing between seasonality and non-seasonality models of spcies--
For runing this chunk, need to run the first chunk of "phenology part" - uploud the data

```{r}
aic_species_season_list = list()

for (i in 1:length(abondance_species))
{

   temp = all_dataF %>% dplyr::select(abondance_species[i], Year, Month, Depth, Fisherman,Start_hh   ) %>% filter(Year >= catch_sum$Year_S[i] )  %>% filter(Year <= catch_sum$Year_E[i] )
  
   
temp = as.data.frame(temp)
   
print(abondance_species[i])


 co <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 print("co")
 
 
  year <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 
  print("year")
  
  
  #create list of model outputs
  species_gam_list=list(co, year )
  
  names(species_gam_list)=c("co" ,"year" )
  
  
  aic_species = AIC_GAM_F(species_gam_list)
    
  #--cerate deviece explain dataframe
  #deviance of "co" model
  dev_ex =  1-co$deviance/co$null.deviance
  #deviance of "year" model
  dev_ex_year = 1-year$deviance/year$null.deviance
  #join to 1 data, create colnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_year)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("co","year"))
    
  #join deviance explain with aic table
 aic_species =  left_join(aic_species, dev_ex)
 
 aic_species_season_list[[i]] =aic_species
  
}#end for

names(aic_species_season_list) = abondance_species

aic_species_season_data <- do.call(rbind, aic_species_season_list)
aic_species_season_data = as.data.frame(aic_species_season_data)
write.csv(aic_species_season_data, "prosseced data/aic_species_season.CSV")



```


#---Phenology graphs: loop - GAM models, AIC test, and graphs for phenology and seasonality of spcies--
For runing this chunk, need to run the first chunk of "phenology part" - uploud the data

```{r}
aic_species_list = list()


for (i in 1:length(abondance_species))
{

   temp = all_dataF %>% dplyr::select(abondance_species[i], Year, Month, Depth, Fisherman,Start_hh   ) %>% filter(Year >= catch_sum$Year_S[i] )  %>% filter(Year <= catch_sum$Year_E[i] )
  
  
   
temp = as.data.frame(temp)
   
print(abondance_species[i])


 co <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 print("co")
 

 #co <- gam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12), data = temp, family = tw)
  
 
  co_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)   + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp, family = tw)
  
 #co_int = gam(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth), data = temp, family = tw)
 
  print("co_int")
  
  
  #create list of model outputs
  species_gam_list=list(co, co_int )
  
  names(species_gam_list)=c("co" ,"co_int" )
  
  
  aic_species = AIC_GAM_F(species_gam_list)
    
  #--cerate deviece explain dataframe
  #deviance of "co" model
  dev_ex =  1-co$deviance/co$null.deviance
  #deviance of "co_int" model
  dev_ex_co_int = 1-co_int$deviance/co_int$null.deviance
  #join to 1 data, create colnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_co_int)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("co","co_int"))
    
  #join deviance explain with aic table
 aic_species =  left_join(aic_species, dev_ex)
  
  aic_species_list[[i]] =aic_species
  

  
  
  model_name = aic_species[1,1]
  model_name = as.character(model_name)
  print(model_name)
  temp_gam = species_gam_list[[model_name]]
  
  
  print(abondance_species[i])
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = abondance_species_subnames[i,3], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.title = element_text(face = "italic"))
    
    

grid.arrange(p1)

ggsave(paste("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 200)
  #, width = 8.5, height = 5.5
  
}#end for

names(aic_species_list) = abondance_species

aic_species_data <- do.call(rbind, aic_species_list)
aic_species_data = as.data.frame(aic_species_data)
write.csv(aic_species_data, "prosseced data/aic_species.CSV")



```
simp <- gam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12), data = temp, family = tw)
  
  print(simp)
   
  co <- gam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp, family = tw)
  
  print(co)
  
  simp_int = gam(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth), data = temp, family = tw)
  
  print(simp_int)
  
  co_int = gam(temp[,1] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp, family = tw)

  print(co_int)

#---Seasonal graphs: loop - create seasonal graphs, without interaction, for interactions' species 

```{r}


int_species = c("Bbo", "Ccr", "DLS", "EPI", "Per", "SAR", "SPH", "Sud", "Upo")
int_species_subnames = abondance_species_subnames %>% filter(Sp_code %in% int_species)

for (i in 1:length(int_species))
{

   temp = all_dataF %>% dplyr::select(int_species[i], Year, Month, Depth, Fisherman,Start_hh   ) %>% filter(Year >= catch_sum$Year_S[i] )  %>% filter(Year <= catch_sum$Year_E[i] )
  
  
   
temp = as.data.frame(temp)
   
print(int_species[i])


 temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 print("co")
 
  
  print(int_species[i])
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = int_species_subnames[i,3], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.title = element_text(face = "italic"))
    
    

grid.arrange(p1)

ggsave(paste("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/phenology/season/",int_species[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/phenology/season/",int_species[i],".png",sep = ""), p1, dpi = 200)
  #, width = 8.5, height = 5.5
  
}#end for

```


#Seasonal model with the bsize years for  Ccr (2001-2012)and Sud (2013,2018) general catch

```{r}

limit_year_species = c("Ccr", "Sud")
limit_year_species_subnames = abondance_species_subnames %>% filter(Sp_code %in% limit_year_species)

for (i in 1:length(limit_year_species))
{

   temp = all_dataF %>% dplyr::select(limit_year_species[i], Year, Month, Depth, Fisherman,Start_hh   ) 
   if (i==1)
   {
   temp = all_dataF %>% filter(Year >= 2001 )  %>% filter(Year <= 2012 ) 
   temp = as.data.frame(temp)

 temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 
   
   }
   
   else
   {
     temp = all_dataF %>% filter(Year >= 2013 )  %>% filter(Year <= 2018 )  
     
     temp = as.data.frame(temp)


 temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr",k=6) + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cc"), data = temp  , family=tw)
 
   }
   
  
  
  print(limit_year_species[i])
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = limit_year_species_subnames[i,3], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.title = element_text(face = "italic"))
    
    

grid.arrange(p1)

ggsave(paste("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/phenology/season/limit year",limit_year_species[i],".png",sep = ""), p1, dpi = 200, width = 8.5, height = 5.5)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/phenology/season/limit year",limit_year_species[i],".png",sep = ""), p1, dpi = 200)
  #, width = 8.5, height = 5.5
  
}#end for

```



#--Interaction graphs: loop - create interaction graphs for the whole species
```{r}
 

for (i in 1:length(abondance_species))
{
  
   temp = all_dataF %>% dplyr::select(Year, Month, Depth, abondance_species[i] ) %>% filter(Year >= catch_sum$Year_S[i] )  %>% filter(Year <= catch_sum$Year_E[i] )
  
temp = as.data.frame(temp)
  
   temp_gam = gam(temp[,4] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = temp, family = tw)
  
  print(abondance_species[i])
  summary(temp_gam)
  #gam.check(temp_gam)
  
    
  #plot(Umo_gam, scheme = 2, n = 200, tran = family(Umo_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate


pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = paste(  "Modelled change in monthly catch", abondance_species_data[i,2],catch_sum$Year_S[i],"-",catch_sum$Year_E[i],sep = " "),
         subtitle = "Marked change in within-year distribution",
         x = NULL,
         y = "Estimated total catch (kg))") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)
    
    

grid.arrange(p1)

ggsave(paste("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)
  
}#end for


```

 temp_gam = getViz( temp_gam)

 print(plot(temp_gam) + labs(title = abondance_species[i]), pages = 1)
   #print(plot(temp_gam) + labs(title = paste(sp_codeF[i],scientific_codeF[i],sep = "-")), pages = 1)

 

try the beuteaful graph from gitHub
https://gist.github.com/gavinsimpson/6d05af9186b9f9419cca5a4507af3aa0







#----------- b size ----------------- 

order the two data (1976-2013 and 2013-2018) to 1

!--NO need to run again-!
```{r}
#uploud data
size_data_1976 = read.csv("data/kg_data_code_1976_2013.CSV")
size_data_2018 = read.csv("data/kg_data_code_2013_2018.CSV")


size_data_1976_se =size_data_1976 %>% dplyr::select(Net_index, Start_Time_hh:Distance_to_Shore,Net_Type,Site:kg_l)
size_data_2018_se =size_data_2018 %>% dplyr::select(Net_index, Start_Time_hh:Distance_to_Shore,Net_Type,Site:kg_l)
size_all_data = rbind(size_data_1976_se,size_data_2018_se)

write.csv(size_all_data, "prosseced data/size all data.CSV")


```



create raw data of b size - plots of the b size species throughout the years, and choos just the relavant species, have enough b size data.

!--NO need to run again-!

```{r}

size_all_data = read.csv("prosseced data/size all data.CSV")

#take just row with b siz = "Zair" only
b_size_all = size_all_data %>% filter(!is.na(kg_b))

#list of the species has b size, and make it character
species_b = unique(b_size_all$species)
species_b = as.character(species_b)
b_size_all$species = as.character(b_size_all$species)

#loop of graphs for any specy
for (i in 1:length(species_b))
{
  tepm_b_species = b_size_all %>% dplyr::select(Year.XXXX.,Month.XX.,species,kg_b) %>% filter(species == species_b[i])

    
    
      
      p=ggplot(tepm_b_species, aes(x=Month.XX., y=kg_b,color=Year.XXXX.)) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year.XXXX.~.)+ggtitle(species_b[i])+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
    grid.arrange(p)
}

  
```


make the beutifule graph in a loop

for now - without depth in the model. if it will be imprtant - need to create the depthes in the "diary" code, and join in. 

#upload require datasets
upload data and replace the dipoldus, Marmir, pijama (Lmo, WHT, DIP, Dce) speciseis with DLS - all of them together
```{r}

#species_names_seperate=species_names_seperate[order(species_names_seperate$Sp_code),]
#I choose just the relevant species
#--!! I removed "Mme", Bakala, because it doesn't exist in species abondance model. to check it ---!!--#
species_b = c("Sd","MUL", "Per", "Nra", "Sud", "Sja", "SPH", "Ccr", "Umo","DLS")
species_b = sort(species_b)

#uplaod relavant years of catch for each species
#table of the species abondance enough for model
catch_b_years = read.csv("prosseced data/years for b size.csv")
catch_b_years = catch_b_years %>% dplyr::select(Species, Year_S, Year_E, Year_sum, Haul_sum)
catch_b_years = catch_b_years[order(catch_b_years$Species),]

size_all_data = read.csv("prosseced data/size all data.CSV")
#take just row with b siz = "Zair" only
b_size_all = size_all_data %>% filter(!is.na(kg_b))
b_size_all$species = as.character(b_size_all$species)
  
# Create replacements data frame
Replaces <- data.frame(from = c("Lmo", "WHT", "DIP", "Dce"), to = rep("DLS",4))

# Replace Dipoludus and Marmir code to LDS
b_size_all <- FindReplace(data = b_size_all, Var = "species", replaceData = Replaces,
                     from = "from", to = "to", exact = FALSE)


#create "species_b_data" - data with sp_code and sceintific names
scientific_namesF = read.csv(file = "prosseced data/sceintific_names_fishes_only.csv", stringsAsFactors = F)
species_b_data = scientific_namesF %>% dplyr::select(Sp_code, Common_name, Scientific_name = scintific_name) %>% filter(Sp_code %in% species_b)
#write.csv(species_b_data,"prosseced data/species_b_names.CSV")

#uploud the data with different collomns for Sp resolution names and the whole name (after execl handy work)
species_b_data = read.csv("prosseced data/species_b_names1.CSV")

```


#----"catch_ex"- exploration, table with number of nets with data for any species each year
```{r}
 catch_exB =b_size_all %>% filter(Year.XXXX.>1990)%>% 
    spread(species, kg_b, fill = 0) %>%
    dplyr::select(Year = Year.XXXX. ,Aal:vakvak) %>% group_by(Year) %>% 
    summarize_all(.fun = function(x) sum(x>0,na.rm = T)) %>% 
    gather(species, Catch, Aal:vakvak, factor_key=TRUE) %>% spread(Year, Catch) %>%
  filter(species %in% species_b)
 
write.csv(catch_exB, "prosseced data/num catch per year b size.CSV")


```


#---loop - GAM models, AIC test comparing between seasonality and non-seasonality models of spcies

```{r}
aic_bsize_season_list = list()


 for (i in 1:length(species_b))
    
{
temp = b_size_all %>% dplyr::select(kg_b ,species, Year=Year.XXXX., Month=Month.XX., Fishermen, Start_Time_hh) %>% filter(species==species_b[i]) %>% filter(Year >= catch_b_years$Year_S[i] )  %>% filter(Year <= catch_b_years$Year_E[i] ) 
  
   
temp = as.data.frame(temp)
   
print(species_b[i])


 #model for "sud" and "sd" species, included just 6 years
if((species_b[i]=="Sud") || (species_b[i]=="Sd"))
{
 
  co =  bam(temp[,1] ~ s(Year, bs = "cr",k=6)  +  s(Month, bs = "cc",k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
  
  year = bam(temp[,1] ~ s(Year, bs = "cr",k=6) + (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
  
}#end if



#model for "sja" species, included just 7 years
else if (species_b[i]=="Sja")
  
{
   co =  bam(temp[,1] ~ s(Year, bs = "cr",k=7)  +  s(Month, bs = "cc",k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
  
  year = bam(temp[,1] ~ s(Year, bs = "cr",k=7) + (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
  
}#end else if



else
{
 co <- bam(temp[,1] ~ s(Year, bs = "cr")  +  s(Month, bs = "cc", k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
 
 print("co")
  
  
 
  year <- bam(temp[,1] ~ s(Year, bs = "cr")+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
    
  print("year")
  
 
}#end else


  #create list of model outputs
  bsize_bam_list=list(co, year )
  names(bsize_bam_list)=c("co" ,"year" ) 
  
  #call to AIC functions
   aic_bsize = AIC_GAM_F(bsize_bam_list)
  
   
    #--cerate deviece explain dataframe
  #deviance of "co" model
  dev_ex =  1-co$deviance/co$null.deviance
  #deviance of "year" model
  dev_ex_year = 1-year$deviance/year$null.deviance
  #join to 1 data, create colnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_year)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("co","year"))
    
  #join deviance explain with aic table
 aic_bsize =  left_join(aic_bsize, dev_ex)
   
   
   #put in the list
  aic_bsize_season_list[[i]] =aic_bsize
 
  
}#end for

names(aic_bsize_season_list) = species_b

aic_bsize_season_data <- do.call(rbind, aic_bsize_season_list)
aic_bsize_season_data = as.data.frame(aic_bsize_season_data)
write.csv(aic_bsize_season_data, "prosseced data/aic_bsize_season.CSV")
 


```


#Just seasonality graphs

```{r}

#!!!---!!CAUTION!!!-----!!!
#the looop does'nt finish. i = 1:5 is OK, and i=10, but i=7 is sja, i=6 sd i=9 is Sud, wich need separete model, whith k=6 at Years.

 for (i in 1:length(species_b))
    
{
temp = b_size_all %>% dplyr::select(kg_b ,species, Year=Year.XXXX., Month=Month.XX., Fishermen, Start_Time_hh) %>% filter(species==species_b[i]) %>% filter(Year >= catch_b_years$Year_S[i] )  %>% filter(Year <= catch_b_years$Year_E[i] ) 
  
   
temp = as.data.frame(temp)
   
print(species_b[i])



 temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr")  +  s(Month, bs = "cc", k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
 
 #model for "sud" and "sd" species, included just 6 years
 #temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr",k=6)  +  s(Month, bs = "cc",k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
 
 #model for "sja" species, included just 7 years
 #temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr",k=7)  +  s(Month, bs = "cc",k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
  
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100),Start_Time_hh = 50,Fishermen = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = species_b_data[i,5], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.title = element_text(face = "italic"))
    
   

grid.arrange(p1)

ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/b size/season",species_b[i],".png",sep = ""), p1, dpi = 200)

#ggsave(paste("C:/Users/Dvora/Google Drive/second degree/thesis/data/R/graphs/b size/season",species_b[i],".png",sep = ""), p1, dpi = 200)
 }#end for

```


#Loop of gam model, AIC, and interaction-seasonality graphs function
```{r}
#remove "Sud" and "Sd", wich has just 6 years, not enough for modeling
species_b = species_b[!species_b%in% c("Sud","Sja","SPH","Sd","Umo")]
b_size_all = b_size_all %>%dplyr::filter(!species %in% c("Sud","Sja","SPH","Sd","Umo"))

aic_bsize_list = list()

species_b_subname = species_b_data %>% filter(Sp_code %in% species_b)

 for (i in 1:length(species_b))
    
{
temp = b_size_all %>% dplyr::select(kg_b ,species, Year=Year.XXXX., Month=Month.XX., Fishermen, Start_Time_hh) %>% filter(species==species_b[i]) %>% filter(Year >= catch_b_years$Year_S[i] )  %>% filter(Year <= catch_b_years$Year_E[i] ) 
  
   
temp = as.data.frame(temp)
   
print(species_b[i])



 co <- bam(temp[,1] ~ s(Year, bs = "cr")  +  s(Month, bs = "cc", k=12)+ (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
 
 print("co")
  
  
 
  co_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)   + ti(Month,Year, bs = c("cc","cr"))  + (Fishermen)+ s(Start_Time_hh, bs = "cc"), data = temp, family = tw )
 
  print("co_int")
  

  #create list of model outputs
  bsize_bam_list=list(co, co_int )
  names(bsize_bam_list)=c("co" ,"co_int" ) 
  
  #call to AIC functions
   aic_bsize = AIC_GAM_F(bsize_bam_list)
  
   
    #--cerate deviece explain dataframe
  #deviance of "co" model
  dev_ex =  1-co$deviance/co$null.deviance
  #deviance of "co_int" model
  dev_ex_co_int = 1-co_int$deviance/co_int$null.deviance
  #join to 1 data, create colnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_co_int)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("co","co_int"))
    
  #join deviance explain with aic table
 aic_bsize =  left_join(aic_bsize, dev_ex)
   
   
   #put in the list
  aic_bsize_list[[i]] =aic_bsize
 
  #extract best model name and gam model
   model_name =  aic_bsize[1,1]
  model_name = as.character(model_name)
  print(model_name)
  temp_gam =  bsize_bam_list[[model_name]]
  
  
  print(species_b[i])
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100),Start_Time_hh = 50,Fishermen = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = species_b_subname[i,5], 
   #      subtitle = species_b_subname[i,6],
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.title = element_text(face = "italic"))
    
   

grid.arrange(p1)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/b size/",species_b[i],".png",sep = ""), p1, dpi = 200)

ggsave(paste("C:/Users/Dvora/Google Drive/second degree/thesis/data/R/graphs/b size/",species_b[i],".png",sep = ""), p1, dpi = 200)
  
}#end for

names(aic_bsize_list) = species_b

aic_bsize_data <- do.call(rbind, aic_bsize_list)
aic_bsize_data = as.data.frame(aic_bsize_data)
write.csv(aic_bsize_data, "prosseced data/aic_bsize.CSV")
 

```

#create interaction gam model graphs for any b size species
```{r}



theme_set(theme_bw())

  for (i in 1:length(species_b))
    
{

   temp = b_size_all %>% dplyr::select(Year=Year.XXXX., Month=Month.XX., species,kg_b ) %>% filter(species==species_b[i]) %>% filter(Year >= catch_b_years$Year_S[i] )  %>% filter(Year <= catch_b_years$Year_E[i] ) 
  
temp = as.data.frame(temp)
  
   temp_gam = gam(temp[,4] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr")) ,data = temp, family = tw)
  
  print(species_b[i])
  summary(temp_gam)
  #gam.check(temp_gam)
  
  
  #  plot(temp_gam, scheme = 2, n = 200, tran = family(temp_gam)$linkinv)
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate

pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100)))  
  
  
## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))

p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = paste(  "Modelled change in monthly catch", species_b_data[i,3],catch_b_years$Year_S[i],"-",catch_b_years$Year_E[i],sep = " "),
    
         x = NULL,
         y = "Estimated total catch (kg))") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)
    
   

    grid.arrange(p1)


ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/b size/",species_b[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)

}#end for



``` 




#look on Mme data

upload data and replace the dipoldus, Marmir, pijama (Lmo, WHT, DIP, Dce) speciseis with DLS - all of them together
```{r}

#species_names_seperate=species_names_seperate[order(species_names_seperate$Sp_code),]
#I choose just the relevant species
#--!! I removed "Mme", Bakala, because it doesn't exist in species abondance model. to check it ---!!--#
species_b = c("Mme")


size_all_data = read.csv("prosseced data/size all data.CSV")
#take just row with b siz = "Zair" only
b_size_all = size_all_data %>% filter(!is.na(kg_b))
b_size_all$species = as.character(b_size_all$species)


scientific_namesF = read.csv(file = "prosseced data/sceintific_names_fishes_only.csv", stringsAsFactors = F)
species_b_data = scientific_namesF %>% dplyr::select(Sp_code, Common_name, Scientific_name = scintific_name) %>% filter(Sp_code %in% species_b)




#----create "catch_ex"- exploration, table with number of nets with data for any species each year

 bakala_exB =b_size_all %>% filter(Year.XXXX.>1990)%>% 
    spread(species, kg_b, fill = 0) %>%
    dplyr::select(Year = Year.XXXX. ,Aal:vakvak) %>% group_by(Year) %>% 
    summarize_all(.fun = function(x) sum(x>0,na.rm = T)) %>% 
    gather(species, Catch, Aal:vakvak, factor_key=TRUE) %>% spread(Year, Catch) %>%
  filter(species %in% species_b)
 
mme_hauls = bakala_exB %>% dplyr::select("2014":"2018")
Mme_Year_E = "2014"
Mme_Year_S = "2018"
hauls_num = rowSums(mme_hauls)





#temporary data, model and graph
temp = b_size_all %>% dplyr::select(kg_b ,species, Year=Year.XXXX., Month=Month.XX., Fishermen, Start_Time_hh) %>% filter(species==species_b) %>% filter(Year >= Mme_Year_E )  %>% filter(Year <= Mme_Year_S ) 
  
temp = as.data.frame(temp)
   
print(species_b)


#compaer between seasonal to non-seasonal modle
simp = bam(temp[,1] ~ s(Year, bs = "cr",k = 4)  +  s(Month, bs = "cc", k=12), data = temp, family = tw )

year = bam(temp[,1] ~ s(Year, bs = "cr",k = 4)  , data = temp, family = tw )

 #create list of model outputs
  Mme_bam_list=list(simp, year )
  names(Mme_bam_list)=c("simp" ,"year" ) 
  
  #call to AIC functions
   aic_Mme = AIC_GAM_F(Mme_bam_list)
  
   
    #--cerate deviece explain dataframe
  #deviance of "simp" model
  dev_ex =  1-simp$deviance/simp$null.deviance
  #deviance of "year" model
  dev_ex_year = 1-year$deviance/year$null.deviance
  #join to 1 data, create colnames, as dataframe, with another column with model names
  dev_ex = rbind(dev_ex, dev_ex_year)
  colnames(dev_ex) = c("dev_ex")
  dev_ex = as.data.frame(dev_ex)
  dev_ex = dev_ex%>% mutate(model_name = c("simp","year"))
    
  #join deviance explain with aic table
 aic_Mme =  left_join(aic_Mme, dev_ex)
 write.csv(aic_Mme, "prosseced data/aic_Mme_season.CSV")  
   
  
  


#at s(Year, bs = "cr",k = 4), k = 4 because there is 4 years with data
 temp_gam <- bam(temp[,1] ~ s(Year, bs = "cr",k = 4)  +  s(Month, bs = "cc", k=12), data = temp, family = tw )
 
 #+ (Fishermen)+ s(Start_Time_hh, bs = "cc")
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100),Start_Time_hh = 50,Fishermen = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = species_b_data[1,3], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.subtitle=element_text(size = 8))
    
   

grid.arrange(p1)

#ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/b size/season",species_b,".png",sep = ""), p1, dpi = 200)

ggsave(paste("C:/Users/Dvora/Google Drive/second degree/thesis/data/R/graphs/b size/season",species_b,".png",sep = ""), p1, dpi = 200)


#rohh data ggplot
p2 = ggplot(data = temp,aes( x = Month, y = kg_b, colour = Year,group = factor(Year)))+
geom_point()+
#geom_line()+
    scale_color_viridis(option = "plasma", end = 0.95)+
    labs(title = species_b_data[1,3], 
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))+
  theme(plot.subtitle=element_text(size = 8))

ggsave(paste("C:/Users/Dvora/Google Drive/second degree/thesis/data/R/graphs/b size/season rough",species_b,".png",sep = ""), p2, dpi = 200)

```











#-------------------------chunks I droped aside--------------------------------------


GAm model

 #gam model
mediter_gam_year = gam(mtc ~ s(Year, bs = "cr") + s(depth_meter) ,data = net_mediter_mtc)

red_gam_year = gam(mtc ~ s(Year, bs = "cr") + s(depth_meter)  ,data = net_red_mtc) 

plots

par(mfrow = c(2,2)) 
  plot(mediter_gam_year,se=TRUE,col = "blue")
  mtext("Mediterranean", side = 3, line = -2, outer = TRUE)
  
  par(mfrow = c(2,2)) 
  plot(red_gam_year,se=TRUE,col = "blue")
  mtext("Red Sea", side = 3, line = -13.5, outer = TRUE)
  
  
  #---seaon model
  #clear memory
  gc()

  
  mediter_gam_season = gam(mtc ~ s(Year, bs = "cr") + s(depth_meter) + s(Season_num, bs = "cc", k=4)+s(SST, bs = "gp") ,data = er_mtc)
   # +s(Date_num, bs = "gp")
  
red_gam_season = gam(mtc ~ s(Year, bs = "cr") + s(depth_meter) + s(Season_num, bs = "cc", k=4) +s(SST, bs = "gp") ,data = net_red_mtc)


par(mfrow = c(2,2)) 
  plot(mediter_gam_season,se=TRUE,col = "blue")
  title("Mediterranean",line = -2, outer=TRUE)
  
par(mfrow = c(2,2)) 
  plot(red_gam_season,se=TRUE,col = "blue")
   title("Red Sea",line = -2, outer=TRUE)
 


the split data [split by origin]------ #
  #data with different column to "origin", any net in 2 rows, 1 for "med" and 1 for "red"    
  
    #create numeric columns frome the date-time "Date_num"
  
  # net_mediter_mtc = net_mediter_mtc %>% mutate(Date_num = as.numeric(Date)) %>% dplyr::select(X:Date,Date_num,Week:Season,Season_num ,everything())
  # 
  # net_red_mtc = net_red_mtc %>% mutate(Date_num = as.numeric(Date)) %>% dplyr::select(X:Date,Date_num,Week:Season,Season_num ,everything())
  # 
  #prepare data for joining: put origin column and delete catch columns
  #split_mediter_mtc = net_mediter_mtc %>% mutate(Origin = "med") %>% dplyr::select(-(Aal:WHT))
   # split_red_mtc = net_red_mtc %>% mutate(Origin = "red") %>% dplyr::select(-(Nra:Upo))
  #split_all_mtc = rbind(split_mediter_mtc,split_red_mtc)
  

  split_all_mtc$Origin =as.factor( split_all_mtc$Origin)
  
    year by origin  --------------
    split_gam_month = gam(mtc ~ s(Year, by = Origin) +Origin  ,data = split_all_mtc)

    + s(depth_meter) + s(Month, bs = "cc", k=12) +s(SST, bs = "gp")
  
par(mfrow = c(2,1)) 
  plot(split_gam_month,se=TRUE,col = "blue")
title("All split",line = -2, outer=TRUE)

    year by origin with the whole covariates----------
split_gam_month = gam(mtc ~offset(Duration) + s(Year, by = Origin) +Origin+ s(depth_meter, bs = "ts") + s(Month, bs = "cc", k=12) +s(SST, bs = "ts")  ,data = split_all_mtc)


par(mfrow = c(3,2)) 
  plot(split_gam_month,se=TRUE,col = "blue")
   summary(split_gam_month)
  


    year and SST by origin with the whole covariates--------------
split_gam_month = gam(mtc ~offset(Duration) + s(Year, by = Origin) +Origin+ s(depth_meter, bs = "ts") + s(Month, bs = "cc", k=12) +s(SST, by = Origin)  ,data = split_all_mtc)

par(mfrow = c(3,2)) 
  plot(split_gam_month,se=TRUE,col = "blue")
  summary(split_gam_mon)

  
  
      sst by origin---------------
 split_gam_month = gam(mtc ~ s(SST, by = Origin) +Origin  ,data = split_all_mtc)
+ s(depth_meter) + s(Month, bs = "cc", k=12) +s(SST, bs = "gp")
  
par(mfrow = c(2,1)) 
  plot(split_gam_month,se=TRUE,col = "blue")
title("All split",line = -2, outer=TRUE)

      check of SST and month corrolation--------------
sst_month_gam <- gam(SST~s(Month, bs = "cc", k=12), data = split_all_mtc)
 summary(sst_month_gam)
  plot(sst_month_gam,se=TRUE,col = "blue")

  
sst_month_gam



  
  
   #-----convert month to factor abn do "by" model--
  med_mtc_mo_fa = net_mediter_mtc %>% dplyr::mutate(Month = as.factor(Month))
  red_mtc_mo_fa = net_red_mtc %>% dplyr::mutate(Month = as.factor(Month))
    
  
  mediter_gam_mo_fa = gam(mtc ~ s(SST, by = Month)   ,data = med_mtc_mo_fa)
    # + s(depth_meter, bs = "ts") offset(Duration) +s(Year, bs = "cr")  ++Month
par(mfrow = c(2,2)) 
  plot(  mediter_gam_mo_fa,se=TRUE,col = "blue")
  summary(  mediter_gam_mo_fa)
  
   red_gam_mo_fa = gam(mtc ~ s(SST, by = Month)   ,data = red_mtc_mo_fa)
      # + s(depth_meter, bs = "ts") offset(Duration) +s(Year, bs = "cr")  ++Month
par(mfrow = c(2,2)) 
  plot(  red_gam_mo_fa,se=TRUE,col = "blue")
  summary(  res_gam_mo_fa)
  


    #--------phnology
    #make a single graph for any quart of the years
  p1= ggplot(month_catchF_a, aes(x=Month, y=month_catchF_a[,sp_codeF[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)


    #species GAM model on single species
  #check on single species
Aal_gam = gam(Aal ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = all_dataF)


  #I tried to put another family, and select, didn't change much
  #, select = T, family=Tweedie(1.25,power(.1))

Aal_gam = getViz(Aal_gam)


print(plot(Aal_gam) + labs(title = "Aal"), pages = 1)

Aal_gam2 = gam(Aal ~ te(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = all_dataF)

Aal_gam2 = getViz(Aal_gam2)


print(plot(sm(Aal_gam2,1)) + labs(title = "Aal"), pages = 1)




  #gma model for speciefic b size graphs
tepm_b_species = b_size_all %>% dplyr::select(Year.XXXX.,Month.XX.,species,kg_b) %>% filter(species == "EPI")

    
    for (i in 1:length(species_b))
{

   temp = b_size_all %>% dplyr::select(Year=Year.XXXX., Month=Month.XX., Depth, species,kg_b ) %>% filter(species==species_b[i]) %>% filter(Year >= catch_b_years$Year_S[i] )  %>% filter(Year <= catch_b_years$Year_E[i] )
  
temp = as.data.frame(temp)
  
   temp_gam = gam(temp[,5] ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr")) ,data = temp, family = tw)
  
  print(species_b[i])
  summary(temp_gam)
  gam.check(temp_gam)
  
   temp_gam = getViz( temp_gam)

 print(plot(temp_gam) + labs(title = species_b[i]), pages = 1)
   #print(plot(temp_gam) + labs(title = paste(sp_codeF[i],scientific_codeF[i],sep = "-")), pages = 1)
 
}#end for



  #---MTC by SST graphs, whith no leaniar corolation
 library(ggpubr)
  
  #with function
ggplot(anom_med, aes(x=SST ,y=mtc, size=3))+
  #geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.5 ,direction = 1,discrete = TRUE, option = "D") +
  ggtitle("MTC by SST")+
  stat_smooth(aes(y=mtc), method = "lm", formula = formula) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
    formula = formula )

ggplot(anom_red, aes(x=SST ,y=mtc, size=3))+
  #geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(1991,2018, by = 2))+ #x axis years apeared
  scale_color_viridis(begin = 0, end = 0.5 ,direction = 1,discrete = TRUE, option = "D") +
  ggtitle("MTC by SST")+
  stat_smooth(aes(y=mtc), method = "lm", formula = formula) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
    formula = formula )



  #---mtc by nomthly sst anomaly---
  #try to do monthly SST anomaly, and it is't in correlation to mtc also, not in linear correlation and not in gam model
  x = net_mediter_mtc %>% dplyr::select(Month, SST, mtc, Depth) %>% group_by(Month) %>% 
    summarise_all(.funs = mean) %>% filter(!is.na(Month)) %>% mutate(SST_anom = SST-mean(SST)) %>% 
    mutate(mtc_anom = mtc-mean(mtc))
  x= x %>% dplyr::select(Month, SST_anom)
  
  y = net_mediter_mtc %>% left_join(x)
  
  plot(x)
  
  mediter_gam_sst = gam(mtc ~ s(Depth) + s(Month, bs = "cc", k=12)+s(SST_anom, bs = "cr") ,data = y)
 par(mfrow = c(2,2)) 
  plot(  mediter_gam_sst,se=TRUE,col = "blue")
  title("Mediter mtc by SST and Month",line = -2, outer=TRUE)
  summary(mediter_gam_sst)
  
  
  #---monthly catch gam
  
   
  #start in 1991, drop NA, create Sum column
  month_red_catch = na.omit(month_red_catch)
  month_red_catch = month_red_catch %>% filter(Year >1990)
  tempor_sum = month_red_catch %>%  dplyr::select(Nra:Upo)
  catch_month_sum = rowSums(tempor_sum)
 month_red_catch = month_red_catch  %>% dplyr::mutate(Sum = cbind(catch_month_sum))
 
 month_mediter_catch = na.omit(month_mediter_catch)
  month_mediter_catch = month_mediter_catch %>% filter(Year >1990)
  tempor_sum = month_mediter_catch %>%  dplyr::select(Aal:WHT)
  catch_month_sum = rowSums(tempor_sum)
 month_mediter_catch = cbind(month_mediter_catch,catch_month_sum)
 month_mediter_catch = month_mediter_catch %>% dplyr::select(Year:WHT,Sum = catch_month_sum)
 
  
  month_mediter_catch_gam = gam(Sum ~ s(Year, bs = "cr") +s(Month, bs = "cc", k=12), data = month_mediter_catch)
  par(mfrow = c(2,1)) 
  plot(  mediter_catch_gam,se=TRUE,col = "blue")
    title("Mediteranean species monthly catch by month And year",line = -2, outer=TRUE)
  
    red_catch_gam = gam(Sum ~ s(Year, bs = "cr") +s(Month, bs = "cc", k=12), data = month_red_catch)
  par(mfrow = c(2,1)) 
  plot(  red_catch_gam,se=TRUE,col = "blue")
  title("Red species monthly catch by month and year",line = -2, outer=TRUE)
  

  #depth by month and years model
depth_gam = gam(Depth ~ s(Year, bs = "cr") +s(Month, bs = "cc", k = 12), data = net_all_data)

par(mfrow = c(2,1)) 
plot(depth_gam,se=TRUE,col = "blue")



  #--interaction gam model
  #upload mediter and red sea data.
net_med_mtc = read.csv("prosseced data/mediter_net_mtc.CSV")
net_red_mtc = read.csv("prosseced data/red_net_mtc.CSV")


  #get out rows without mtc and depth deeper than 100 m or shallower than 20 m
  net_med_mtc = net_med_mtc %>%  dplyr:: filter(!is.na(mtc)) %>% filter(!is.na(Depth)) %>% filter(Depth<100)
  
  net_red_mtc = net_red_mtc %>% dplyr:: filter(!is.na(mtc)) %>% filter(!is.na(Depth)) %>% filter(Depth<100)
  
 # start the in 1991 [year]
 net_red_mtc = net_red_mtc %>% filter(Year > 1990)
 net_med_mtc = net_med_mtc %>% filter(Year > 1990)
 
 
 #GAM models
 #interactions between month and year
 med_gam_Tint = gam(mtc ~ te(Month, bs = "cc", k=12) + te(Year, bs = "cr")  + ti(Month,Year, bs = c("cc","cr"))+s(Depth) ,data = net_med_mtc)
 
  red_gam_Tint = gam(mtc ~ te(Month,Year, bs = c("cc","cr"),k=12)+s(Depth),data = net_red_mtc)
 
  med_gam_Tint = 
    
 red_gam_Tint = getViz(red_gam_Tint)
 
  print(plot(sm(med_gam_Tint,3)), ask = FALSE)
 print(plot(sm(red_gam_Tint,3)), ask = FALSE)
 
  #plot(sm(med_gam_Tint, 1)) + l_fitRaster(pTrans = zto1(0.05, 2, 0.1), noiseup = TRUE) +
 # l_rug() + l_fitContour()


  #--nice and non-understanding 3 diamantios interactive graph

ck <- check2D(red_gam_Tint, x1 = "Month", x2 = "Year", type = "tnormal")

glyFun <- function(.d){
  .r <- .d$z
  .qq <- as.data.frame( density(.r)[c("x", "y")], n = 100 )
  .qq$colour <- rep(ifelse(length(.r)>50, "black", "red"), nrow(.qq))
  return( .qq )
}

ck + l_glyphs2D(glyFun = glyFun, ggLay = "geom_path", n = c(8, 8),
                mapping = aes(x=gx, y=gy, group = gid, colour = I(colour)), 
                height=1.5, width = 1)

plotRGL(sm(red_gam_Tint, 1), fix = c("z" = 0), residuals = FALSE)


  #-------interactions between depth and year

 
med_gam_Dint = gam(mtc ~te(Depth)+te(Year, bs = "cr") + ti(Depth,Year, bs = c("cr","cr")) ,data = net_med_mtc)

 
  red_gam_Dint = gam(mtc ~ te(Depth)+te(Year, bs = "cr") + ti(Depth,Year, bs = c("cr","cr")),data = net_red_mtc)
 
  med_gam_Dint = getViz(med_gam_Dint)
 red_gam_Dint = getViz(red_gam_Dint)
 
 print(plot(sm(med_gam_Dint,3)), ask = FALSE)
 print(plot(sm(red_gam_Dint,3)), ask = FALSE)



  #---------- mtc spcies model------------------------

There is problem in that chunk - work just if running the whole code

  #upload codes, and mediter and red sea data.
  # scientific_names=read.csv(file = "prosseced data/sceintific_names_fishes_known_origin.csv", stringsAsFactors = F)
  # #cerate species names vector
  #  sp_code = scientific_names$Sp_code
  #  scientific_code = scientific_names$scintific_name
  #   
  # mean_tcode =read.csv( "prosseced data/mean_tcode.CSV")
  # 
  # species_to_scientific_name=read.csv(file= "prosseced data/sceintific_names_fishes_known_origin.csv",stringsAsFactors = F)
  # 
  # net_mediter_mtc = read.csv("prosseced data/mediter_net_mtc.CSV")
  # net_red_mtc = read.csv("prosseced data/red_net_mtc.CSV")
  # 
  # #sp_code of the mediterrinian and red sea origin 
  # mediter_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Med"),"Sp_code"]
  # red_code=species_to_scientific_name[which(species_to_scientific_name$Origin=="Red"),"Sp_code"]
  #get out rows without mtc and depth deepre than 100 m or shallower than 20 m
   # net_mediter_mtc = net_mediter_mtc %>%  dplyr:: filter(!is.na(mtc)) %>% filter(Depth %in% c(20:100) ) 
  #  net_red_mtc = net_red_mtc %>%  dplyr:: filter(!is.na(mtc)) %>% filter(Depth %in% c(20:100))
  
   
  
  #table with namse of species and Tpref
    species_table = cbind(sp_code,scientific_code,mean_tcode)
mediter_table=species_table[which(rownames(species_table) %in% c("MUL","BAT","Bbo","Mme","WHT","Arg","EPI","Pca","SPI","Lmo","Sd","Bca","Per","Sja")),]
red_table=species_table[which(!(rownames(species_table) %in% mediter_code)),]




  #the abundance invasive species model
Nra_gam = gam(Nra ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_red_mtc)
  par(mfrow = c(2,2)) 
  plot( Nra_gam,se=TRUE,col = "blue")
    title(paste( red_table[which(rownames(red_table)=="Nra"),2],"T pref =",red_table[which(rownames(red_table)=="Nra"),3],sep = " "),line = -2, outer=TRUE)
    
    Sco_gam = gam(Sco ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_red_mtc)
  par(mfrow = c(2,2)) 
  plot( Sco_gam,se=TRUE,col = "blue")
    title(paste( red_table[which(rownames(red_table)=="Sco"),2],"T pref =",red_table[which(rownames(red_table)=="Sco"),3],sep = " "),line = -2, outer=TRUE)
    
    
    
    
Sco_gam = getViz(Sco_gam)

plot( sm(Sco_gam, 3) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5,size = 25))+labs(y ="Relative catch [kg]",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,100)) 

plot( sm(Sco_gam, 2) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5,size = 25))+labs(y ="Relative catch [kg]")+scale_x_continuous (breaks=seq(1,12, by = 1)) 

    
    
    
 Umo_gam = gam(Umo ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_red_mtc)
  par(mfrow = c(2,2)) 
  plot( Umo_gam,se=TRUE,col = "blue")
    title(paste( red_table[which(rownames(red_table)=="Umo"),2],"T pref =",red_table[which(rownames(red_table)=="Umo"),3],sep = " "),line = -2, outer=TRUE)
    
  Umo_gam = getViz(Umo_gam)

plot( sm(Umo_gam, 3) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5,size = 25))+labs(y ="Relative catch [kg]",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,100)) 

plot( sm(Umo_gam, 2) )+ l_ciPoly()+l_fitLine(colour = "red")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5,size = 25))+labs(y ="Relative catch [kg]")+scale_x_continuous (breaks=seq(1,12, by = 1)) 


  #the abundance Mediter species model "MUL" "BAT" "Bbo" "Mme" "WHT"
    
 MUL_model = gam(MUL ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( MUL_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="MUL"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="MUL"),3],sep = " "),line = -2, outer=TRUE)
    
     BAT_model = gam(BAT ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( BAT_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="BAT"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="BAT"),3],sep = " "),line = -2, outer=TRUE)

    
     Bbo_model = gam(Bbo ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( Bbo_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="Bbo"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="Bbo"),3],sep = " "),line = -2, outer=TRUE)

    
    Bbo_model = getViz(Bbo_model)

plot( sm(Bbo_model, 3) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5, size = 25))+labs(y ="Relative catch [kg]",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,100)) 

plot( sm(Bbo_model, 2) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5, size = 25))+labs(y ="Relative catch [kg]")+scale_x_continuous (breaks=seq(1,12, by = 1)) 

    
    
     Mme_model = gam(Mme ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( Mme_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="Mme"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="Mme"),3],sep = " "),line = -2, outer=TRUE)

    
     WHT_model = gam(WHT ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( WHT_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="WHT"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="WHT"),3],sep = " "),line = -2, outer=TRUE)

  #the non abundance Mediter species model - high Tpref - Sd, EPI, Bca, Lmo

    Sd_model = gam(Sd ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( Sd_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="Sd"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="Sd"),3],sep = " "),line = -2, outer=TRUE)
    
     Sd_model = getViz(Sd_model)

plot( sm(Sd_model, 3) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5, size = 25))+labs(y ="Relative catch [kg]",x="Depth [m]")+scale_x_continuous (breaks=seq(20,100, by = 10),limits = c(20,100)) 

plot( sm(Sd_model, 2) )+ l_ciPoly()+l_fitLine(colour = "blue")  + theme(text = element_text(size=30),axis.text.x = element_text(angle=0, hjust=1),axis.title.x = element_text(vjust = -0.5),axis.title.y = element_text(vjust = 0.5, size = 25))+labs(y ="Relative catch [kg]")+scale_x_continuous (breaks=seq(1,12, by = 1)) 

    

    
    EPI_model = gam(EPI ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
 
   plot( EPI_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="EPI"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="EPI"),3],sep = " "),line = -2, outer=TRUE)
    
    Bca_model = gam(Bca ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( Bca_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="Bca"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="Bca"),3],sep = " "),line = -2, outer=TRUE)
    
    Lmo_model = gam(Lmo ~ s(Year, bs = "cs") +s(Month, bs = "cc", k=12)+s(Depth, bs = "cs",k=8), data = net_mediter_mtc)
  par(mfrow = c(2,2)) 
  plot( Lmo_model,se=TRUE,col = "blue")
    title(paste( mediter_table[which(rownames(mediter_table)=="Lmo"),2],"T pref =",mediter_table[which(rownames(mediter_table)=="Lmo"),3],sep = " "),line = -2, outer=TRUE)
    
    #---------month model with SST and without year--------------
  
  
  mediter_gam_sst = gam(mtc~s(Depth) + s(Month, bs = "cc", k=12)+s(SST, bs = "gp") ,data = net_mediter_mtc)
 par(mfrow = c(2,2)) 
  plot(  mediter_gam_sst,se=TRUE,col = "blue")
  title("Mediter mtc by SST and Month",line = -2, outer=TRUE)
  summary(mediter_gam_sst)
  
   red_gam_sst = gam(mtc~s(Depth) + s(Month, bs = "cc", k=12)+s(SST, bs = "gp") ,data = net_red_mtc)
 par(mfrow = c(2,2)) 
  plot(  red_gam_sst,se=TRUE,col = "blue")
  title("red mtc by SST and Month",line = -2, outer=TRUE)
  summary(red_gam_sst)

catch graphs
```{r}

#call the monthly catch function
 month_catchF=month_catch(all_dataF,sp_codeF)
#begen in 1987
 month_catchF=month_catchF[month_catchF$Year %in% c(1987:2018),] 
 
#create data frame for any quart of the years
month_catchF_a=  month_catchF[month_catchF$Year %in% c(1987:1994),]
month_catchF_b=  month_catchF[month_catchF$Year %in% c(1995:2002),]
month_catchF_c=  month_catchF[month_catchF$Year %in% c(2003:2010),]
month_catchF_d=  month_catchF[month_catchF$Year %in% c(2011:2018),]
 

    for (i in 1:length(sp_codeF)) {
  
#make a single graph for any quart of the years
  p1= ggplot(month_catchF_a, aes(x=Month, y=month_catchF_a[,sp_codeF[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  
  p2=ggplot(month_catchF_b, aes(x=Month, y=month_catchF_b[,sp_codeF[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  p3=ggplot(month_catchF_c, aes(x=Month, y=month_catchF_c[,sp_codeF[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
  p4=ggplot(month_catchF_d, aes(x=Month, y=month_catchF_d[,sp_codeF[i]],color=Year )) +
    geom_line()+
    scale_colour_gradientn(colours=rainbow(4))+
    facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
    ylab("Number of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)
  
 #ceate one graph included 4 graphs for any species
  #grid.arrange(p1, p3, p2, p4,ncol=2)
  grid.arrange(p4)
  
  #if saving without the "g" part, save just 1 of the 4, but in high resolution
  #so it's better for papars. [could order them by nyself after]
  #order for saving
  #g <- arrangeGrob(p1, p3, p2, p4, nrow=2) #generates g
  #ggsave(file = paste (sp_codeF[i],"png",sep ="."),g)

  }#end for
 

```


weekly normalization

 
      #create week ID coulmn wich I can count - year/month/week
      all_dataF$Week_ID = with(all_dataF,paste(Year,Month,Week,sep = "/"))
      #count how many nets in every week [count Week ID]
      week_count=all_dataF %>% group_by(Week_ID) %>% summarise(count=n()) 

      
 
    #take the week_ID and species
    week_data= dplyr:: select(all_dataF,Week_ID,Aal:WHT)
    #sum of weekly catch of each speceis: aggergate by ID
   week_data=week_data %>% group_by(Week_ID) %>% summarise_all(funs(sum))

    #create weekly mean catch:diviate the weekly sum of catch of each species in the 
    #sum of nets in the week
    week_data=week_data %>% dplyr:: select(Aal:WHT)   
    week_data=week_data/week_count$count  
    
    #seperate the Id string to Year and Week and bind to "week data"
    week_id_sep=week_count %>% separate(Week_ID,c("Year","Month","Week"))
    week_data=cbind("Week_ID"= week_count$Week_ID,"Year"=week_id_sep$Year,"Week"=week_id_sep$Week ,week_data)

    week_data$Week=as.numeric(as.character(week_data$Week))  
    week_data$Year=as.numeric(as.character(week_data$Year))
   
  
   
    
        
    #begen in 1987
    week_data=week_data[week_data$Year %in% c(1987:2018),] 
    
    #create data frame for any quart of the years
    week_data_a=  week_data[week_data$Year %in% c(1987:1994),]
    week_data_b=  week_data[week_data$Year %in% c(1994:2002),]
    week_data_c=  week_data[week_data$Year %in% c(2001:2010),]
    week_data_d=  week_data[week_data$Year %in% c(2007:2018),]
    



graphs of the ratio catch


    
    for (i in 1:length(sp_codeF)) {
      
      #make a single graph for any quart of the years
      p1= ggplot(week_data_a, aes(x=Week, y=week_data_a[,sp_codeF[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      
      p2=ggplot(week_data_b, aes(x=Week, y=week_data_b[,sp_codeF[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      p3=ggplot(week_data_c, aes(x=Week, y=week_data_c[,sp_codeF[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      p4=ggplot(week_data_d, aes(x=Week, y=week_data_d[,sp_codeF[i]],color=Year )) +
        geom_line()+
        scale_colour_gradientn(colours=rainbow(4))+
        facet_grid(Year~.)+ggtitle(paste (sp_codeF[i],scientific_codeF[i],sep =" - "))+
        ylab("Mean Catches Per Net")+scale_x_continuous(breaks = seq(1,53,by=4))
      
      
      #ceate one graph included 4 graphs for any species
  grid.arrange(p1, p3, p2, p4,ncol=2)
      
      #save the graphs - !!set the directory before use!!
      #if saving without the "g" part, save just 1 of the 4, but in high resolution
      #so it's better for papars. [could order them by myself after]
        #order for saving
        #g <- arrangeGrob(p1, p3, p2, p4, nrow=2) #generates g
        g <- arrangeGrob( p4) #generates g
        ggsave(file = paste (sp_codeF[i],"png",sep ="."),g)
      
    }#end for


  #-- correlation between mtc and SST wiht lag
  

  #create data with lag between MTC and SST
  #Mediterranean Sea
lag_1_sst_m = anom_med %>% select(Year_lag = Year, SST, SST_anom) %>% filter(Year_lag != 2018)
lag_2_sst_m = lag_1_sst_m %>% select(Year_lag, SST, SST_anom) %>% filter(Year_lag != 2017)
lag_3_sst_m = lag_2_sst_m %>% select(Year_lag, SST, SST_anom) %>% filter(Year_lag != 2016)

lag_1_m =anom_med %>% select(Year, mtc, mtc_anom) %>% filter(Year != 1991) %>% cbind(lag_1_sst_m)
lag_2_m =lag_1_m %>% select(Year, mtc, mtc_anom) %>% filter(Year != 1992)%>% cbind(lag_2_sst_m)
lag_3_m =lag_2_m %>% select(Year, mtc, mtc_anom) %>% filter(Year != 1993)%>% cbind(lag_3_sst_m)

  #red Sea
lag_1_sst_r = anom_red %>% select(Year_lag = Year, SST, SST_anom) %>% filter(Year_lag != 2018)
lag_2_sst_r = lag_1_sst_r %>% select(Year_lag, SST, SST_anom) %>% filter(Year_lag != 2017)
lag_3_sst_r = lag_2_sst_r %>% select(Year_lag, SST, SST_anom) %>% filter(Year_lag != 2016)

lag_1_r =anom_red %>% select(Year, mtc, mtc_anom) %>% filter(Year != 2001) %>% cbind(lag_1_sst_r)
lag_2_r =lag_1_r %>% select(Year, mtc, mtc_anom) %>% filter(Year != 2002)%>% cbind(lag_2_sst_r)
lag_3_r =lag_2_r %>% select(Year, mtc, mtc_anom) %>% filter(Year != 2003)%>% cbind(lag_3_sst_r)


  #1-3 lag mean value graphs
  #1
  ggplot(lag_1_m, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 1 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_1_r, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species- 1 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")


 #2
  ggplot(lag_2_m, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 2 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_2_r, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species- 2 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")

 #3
  ggplot(lag_3_m, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 3 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_3_r, aes(x=SST ,y=mtc, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC")+#axis text
 scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species- 3 year lag, MTC by SST")+
  stat_smooth(aes(y = mtc), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")






  #1-3 lag anomaly value graphs
  #1
ggplot(lag_1_m, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 1 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_1_r, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species - 1 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")

  #2
ggplot(lag_2_m, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 2 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_2_r, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species - 2 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")

  #3
ggplot(lag_3_m, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(18,23, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Mediterranean Sea species - 3 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5) 


ggplot(lag_3_r, aes(x=SST_anom ,y=mtc_anom, size=3))+
  geom_point()+
    scale_size(guide = 'none')+#no legend to the "size"
  theme(text = element_text(size=20),axis.text.x = element_text(angle=90, hjust=1))+#size of text
  labs(y ="MTC anomaly", x = "SST anomaly")+#axis text
 #scale_x_continuous (breaks=seq(19,26, by = 1))+ 
  #scale_y_continuous (breaks=seq(25,28, by = 0.5))+
  scale_color_viridis(begin = 0, end = 0.8 ,direction = 1,discrete = FALSE, option = "D") +
  ggtitle("Red Sea species - 3 year lag, MTC anomaly by SST anomaly")+
  stat_smooth(aes(y = mtc_anom), #smooth to mtc, with no shadow
              method = "lm", formula = formula_l, se = T, size = 1.5, color = "red")



  #---create month sum without Year



  #take just the relevant column 
  month_sum=dplyr:: select(all_data,Month,species_code)
    #sum the cathc by month by year
    month_sum=aggregate.data.frame(month_sum,list(month_sum$Month),FUN = sum,drop=F)
    #rename the new column and drop sum of years and month   
    month_sum=month_sum %>% dplyr:: select(Month=Group.1,species_code ) %>% filter(Month %in% c(1:12))
    
    scientific_names=read.csv(file = "prosseced data/sceintific_names_fishes_known_origin.csv", stringsAsFactors = F)
  #cerate species names vector
 sp_code = scientific_names$Sp_code
 scientific_code = scientific_names$scintific_name

 #get out columns with catch sum small than 1000 KG
   catch_sum = colSums(month_sum)
   catch_logic= catch_sum>2000
month_sum = month_sum[,catch_logic]
month_sum = month_sum %>% mutate(Month = c(1:12))

  #separate to mediter and red sea
mediter_month_sum=month_sum[,which(!(colnames(month_sum) %in% red_code))]
red_month_sum=month_sum[,which(!(colnames(month_sum) %in% mediter_code))]

mediter_month_sum_1 = mediter_month_sum %>%dplyr:: select(MUL,BAT,Bbo,Mme,WHT,Month)
mediter_month_sum_2 = mediter_month_sum %>%dplyr:: select(Arg,EPI,Pca,SPI,Month)
mediter_month_sum_3 = mediter_month_sum %>%dplyr:: select(Lmo,Sd,Bca,Per,Sja,Month)

  #covert to long format
red_month_long <- melt(red_month_sum, id="Month")  # convert to long format
mediter_month_long_1 <- melt(mediter_month_sum_1, id="Month")  # convert to long format
mediter_month_long_2 <- melt(mediter_month_sum_2, id="Month")  # convert to long format
mediter_month_long_3 <- melt(mediter_month_sum_3, id="Month")  # convert to long format

ggplot(red_month_long , aes(x=Month,  y=value, colour=variable)) +
    geom_line(size = 1)+
    #scale_colour_gradientn(colours=rainbow(4))+
    #ggtitle(paste (sp_code[i],scientific_code[i],"Preffrence Temperature" ,mean_tcode[i,1],sep =" - "))+
    ylab("Sum of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)+
    theme(text = element_text(size=20),axis.text.x = element_text( hjust=1))#size of text
    
ggplot(mediter_month_long_1 , aes(x=Month,  y=value, colour=variable)) +
    geom_line(size = 1)+
    #scale_colour_gradientn(colours=rainbow(4))+
    #ggtitle(paste (sp_code[i],scientific_code[i],"Preffrence Temperature" ,mean_tcode[i,1],sep =" - "))+
    ylab("Sum of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)+
    theme(text = element_text(size=20),axis.text.x = element_text( hjust=1))#size of text

ggplot(mediter_month_long_2 , aes(x=Month,  y=value, colour=variable)) +
    geom_line(size = 1)+
    #scale_colour_gradientn(colours=rainbow(4))+
    #ggtitle(paste (sp_code[i],scientific_code[i],"Preffrence Temperature" ,mean_tcode[i,1],sep =" - "))+
    ylab("Sum of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)+
    theme(text = element_text(size=20),axis.text.x = element_text( hjust=1))#size of text

ggplot(mediter_month_long_3 , aes(x=Month,  y=value, colour=variable)) +
    geom_line(size = 1)+
    #scale_colour_gradientn(colours=rainbow(4))+
    #ggtitle(paste (sp_code[i],scientific_code[i],"Preffrence Temperature" ,mean_tcode[i,1],sep =" - "))+
    ylab("Sum of Catchs [Kg]")+scale_x_continuous(breaks = 1:12)+
    theme(text = element_text(size=20),axis.text.x = element_text( hjust=1))#size of text





  For runing this chunk, need to run the first chunk of "phenology part" - uploud the data

  ```{r}
aic_species_list = list()

    for (i in 1:length(abondance_species))
  {

   temp = all_dataF %>% dplyr::select(abondance_species[i], Year, Month, Depth, Fisherman,Start_hh   ) %>% filter(Year >= catch_sum$Year_S[i] )  %>% filter(Year <= catch_sum$Year_E[i] )
  
temp = as.data.frame(temp)
   
print(abondance_species[i])

 co <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cr"), data = temp  )
 print("co")
  
  co_1 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.1, data = temp  )
  
  print("co_1") 
   
  co_3 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.3, data = temp )
  
  
  print("co_3")
  
  co_5 <- bam(temp[,1] ~ s(Year, bs = "cr") + s(Depth) +  s(Month, bs = "cc", k=12)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.5, data = temp)
  
  print("co_5")
 
  co_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)   + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cr"), data = temp)
 print("co_int")
  
  co_1_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.1, data = temp )
  
  print("co_1_int") 
   
  co_3_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12) + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.3, data = temp )
  
  print("co_3_int")
  
  co_5_int <- bam(temp[,1] ~ te(Year, bs = "cr") + te(Month, bs = "cc", k=12)  + ti(Month,Year, bs = c("cc","cr"))+s(Depth)+ (Fisherman)+ s(Start_hh, bs = "cr"), rho = 0.5, data = temp)
  
  print("co_5_int")
  
  
  #create list of model outputs
  species_bam_list=list(co, co_1, co_3, co_5,co_int, co_1_int, co_3_int, co_5_int )
  
  names(species_bam_list)=c("co" ,"co_1", "co_3", "co_5","co_int" ,"co_1_int", "co_3_int", "co_5_int" )
  
  
  aic_species = AIC_GAM_F(species_bam_list)
  
  aic_species_list[[i]] =aic_species
   
  model_name = aic_species[1,1]
  model_name = as.character(model_name)
  print(model_name)
  temp_gam = species_bam_list[[model_name]]
  
  
  print(abondance_species[i])
    
  
  ## Look at the fitted model
ilink <- family(temp_gam)$linkinv   # this is the inverse of the link function, as an R function

## Generate new data to predict at; to get smooth plots use ~ 100 evenly spaced values for each covariate
pdata <- with(temp, expand.grid(Year = seq(min(Year), max(Year), length.out = 100),
                                  Month = seq(1, 12, length.out = 100), Depth =30,Start_hh = 50,Fisherman = "Levi"))

## Add on the fitted values and SEs *on the log [link] scale*
pdata <- cbind(pdata, as.data.frame(predict(temp_gam, newdata = pdata, type = "link", se.fit = TRUE)))

## Compute 95% confidence interval on link scale & back transform this & model fit to response scale
pdata <- transform(pdata,
                   Upper  = ilink(fit + (1.96 * se.fit)),
                   Lower  = ilink(fit - (1.96 * se.fit)),
                   Fitted = ilink(fit))



p1 <- ggplot(pdata, aes(x = Month, y = Fitted, colour = Year,group = factor(Year))) +
    geom_line() +
    scale_color_viridis(option = "plasma", end = 0.95) +
    labs(title = paste( abondance_species_data[i,2],catch_sum$Year_S[i],"-",catch_sum$Year_E[i],sep = " "),
         x = NULL,
         y = "Relative catch") +
    scale_x_continuous(breaks = 1:12, minor_breaks = NULL, labels = month.abb)+
  theme_update(text = element_text(size=20))
    
    

grid.arrange(p1)

  #ggsave(paste("C:/Users/dvora/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 100, width = 8.5, height = 5.5)

ggsave(paste("C:/Users/Admin/Google Drive/second degree/thesis/data/R/graphs/phenology/",abondance_species[i],".png",sep = ""), p1, dpi = 200)
  #, width = 8.5, height = 5.5
  
}#end for

names(aic_species_list) = abondance_species
aic_species_list = aic_species_list %>% lapply(function(x){
  arrange(x,AIC)%>% 
  mutate(delta = AIC - first(AIC))
})

lapply(aic_species_list, function(x) write.table( data.frame(x), 'aic_species_list.csv'  , append= T, sep=',' ))


```

